<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homa - Build to Impact</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        body {
            margin: 0; padding: 0; background-color: #222;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; font-family: 'VT323', 'Arial', sans-serif;
            overflow: hidden; color: white; user-select: none;
        }
        #gameContainer {
            position: relative; width: 100%; max-width: 400px; height: 600px;
            background: linear-gradient(to bottom, #6eb1ff 0%, #a3d4ff 100%);
            overflow: hidden; border: 4px solid #333; border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7); image-rendering: pixelated;
        }
        #projectStatus {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8); color: #fff;
            padding: 8px 0; text-align: center; font-size: 16px; z-index: 15;
            border-bottom: 3px solid #FFD700;
        }
        #scoreBoard {
            position: absolute; top: 50px; left: 20px;
            font-size: 28px; font-weight: bold; color: #fff; z-index: 10;
            text-shadow: 2px 2px 0 #000;
        }
        #startScreen, #gameOverScreen, #successScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; text-align: center; backdrop-filter: blur(5px);
        }
        .panel {
            background: #f7e26b; color: #4a3314; padding: 25px;
            border: 4px solid #4a3314; width: 80%; max-width: 300px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.4); animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        h1 { margin: 0 0 10px 0; color: #d95763; text-shadow: 3px 3px 0 #4a3314; font-size: 48px; }
        h2 { margin: 0 0 10px 0; font-size: 32px; }
        button.action-btn {
            background: #ff7f00; border: 3px solid #000; padding: 10px 25px; color: white;
            font-size: 24px; cursor: pointer; margin-top: 15px; width: 100%; 
            font-weight: bold; font-family: 'VT323', sans-serif;
            box-shadow: 4px 4px 0 #000; transition: all 0.05s;
        }
        button.action-btn:active { transform: translate(4px, 4px); box-shadow: 0 0 0 #000; }
        .hidden { display: none !important; }

        /* Ú¯Ø±Ø§ÙÛŒÚ©â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø¯ */
        #player {
            position: absolute; width: 40px; height: 40px; bottom: 96px; left: 50px; z-index: 5;
            background-repeat: no-repeat; background-size: contain;
            /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø§Ù„Ø§ Ù¾Ø§ÛŒÛŒÙ† Ù¾Ø±ÛŒØ¯Ù† Ø¨Ø±Ø§ÛŒ Ø§Ù„Ù‚Ø§ÛŒ Ø¯ÙˆÛŒØ¯Ù† */
            animation: bob 0.2s infinite alternate;
        }
        @keyframes bob { from { transform: translateY(0); } to { transform: translateY(-2px); } }
        
        .obstacle {
            position: absolute; width: 40px; height: 40px; bottom: 96px; z-index: 4;
            background-repeat: no-repeat; background-size: contain;
        }
        .collectible {
            position: absolute; width: 32px; height: 32px; z-index: 4;
            background-repeat: no-repeat; background-size: contain;
            animation: float 0.8s infinite alternate; filter: drop-shadow(0 0 5px gold);
        }
        @keyframes float { from { transform: translateY(0); } to { transform: translateY(-8px); } }

        #ground {
            position: absolute; bottom: 0; width: 100%; height: 96px; z-index: 3;
            background-repeat: repeat-x; border-top: 4px solid #4a7c28;
        }
        .cloud {
            position: absolute; color: rgba(255,255,255,0.8); font-size: 60px;
            top: 50px; animation: moveClouds 20s linear infinite;
        }
        @keyframes moveClouds { from { left: 450px; } to { left: -150px; } }
        
        .donation-control { margin: 15px 0; text-align: center; }
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #ff7f00; }
        .price-tag { background: #fff; border: 2px solid #4a3314; color: #2E7D32; padding: 5px 10px; font-weight: bold; display: block; margin-top: 5px;}
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="projectStatus">
        ğŸ—ï¸ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø¯Ø±Ø³Ù‡: <b>ÙØ§Ø² Û± - ÙÙˆÙ†Ø¯Ø§Ø³ÛŒÙˆÙ†</b><br>
        Ù¾ÛŒØ´Ø±ÙØª: <span id="raisedFundsDisplay" style="color:#4CAF50">Loading...</span> / 0.5 ETH
    </div>
    <div class="cloud" style="top:20px; animation-duration: 25s;">â˜ï¸</div>
    <div class="cloud" style="top:70px; animation-duration: 18s; animation-delay: 6s; font-size: 40px;">â˜ï¸</div>
    <div id="scoreBoard">ğŸ§± 0 <span style="font-size:20px; margin-right:10px;">(â¤ï¸ 0)</span></div>
    
    <div id="startScreen">
        <h1>HOMA RUNNER</h1>
        <p style="color:#fff; font-size: 20px; text-shadow: 2px 2px 0 #000;">Ù†Ø³Ø®Ù‡ Ø¢Ù„ÙØ§ - Ú¯Ø±Ø§ÙÛŒÚ© Ø®ÙˆØ¯Ú©Ø§Ø±</p>
        <button class="action-btn" onclick="startGame(event)">START GAME</button>
    </div>

    <div id="gameOverScreen" class="hidden">
        <div class="panel">
            <h2>GAME OVER</h2>
            <div style="display:flex; justify-content:space-around; font-size: 24px;">
                <div>ğŸ§± <b id="finalBricks">0</b></div> <div>â¤ï¸ <b id="finalHearts">0</b></div>
            </div>
            <hr style="border: 2px solid #4a3314; margin: 10px 0;">
            <div class="donation-control">
                <label>Ø¶Ø±ÛŒØ¨ Ø¯ÙˆÙ†ÛŒØ´Ù†: <span id="multiplierValue" style="color:#d95763; font-weight:bold;">1x</span></label>
                <input type="range" id="multiplierSlider" min="1" max="100" value="1" oninput="updateDonationCalc()">
                <div style="font-size: 14px; margin-top:5px;">Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ:</div>
                <div id="finalRankScore" style="font-size: 28px; font-weight: bold; color:#d95763;">0</div>
                <span class="price-tag">Ù…Ø¨Ù„Øº: <span id="ethCost">0.00001</span> ETH</span>
            </div>
            <button id="payBtn" class="action-btn" style="background: #2ecc71;" onclick="processPayment()">PAY & RANK UP</button>
            <button onclick="startGame(event)" style="background:none; border:none; color:#4a3314; margin-top:10px; cursor:pointer; text-decoration:underline; font-family: 'VT323'; font-size: 20px;">TRY AGAIN</button>
        </div>
    </div>

    <div id="successScreen" class="hidden">
        <div class="panel">
            <div style="font-size: 50px;">ğŸ‰</div>
            <h3>SUCCESS!</h3>
            <p>ØªØ±Ø§Ú©Ù†Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.</p>
            <button class="action-btn" style="background: #2ecc71;" onclick="reloadGame()">CONTINUE</button>
        </div>
    </div>

    <div id="player"></div>
    <div id="ground"></div>
</div>

<script type="module">
    import sdk from 'https://esm.sh/@farcaster/frame-sdk';
    try { sdk.actions.ready(); } catch(e) { console.log("SDK Ready Error (Local):", e); }
</script>

<script>
    // --- Ù…ÙˆØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø±Ø§ÙÛŒÚ© Ø®ÙˆØ¯Ú©Ø§Ø± (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„) ---
    function generateAssets() {
        // 1. ØªÙˆÙ„ÛŒØ¯ Ø²Ù…ÛŒÙ† (Ø¢Ø¬Ø±)
        const canvasG = document.createElement('canvas'); canvasG.width = 32; canvasG.height = 32;
        const ctxG = canvasG.getContext('2d');
        ctxG.fillStyle = '#8B4513'; ctxG.fillRect(0,0,32,32); // Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ
        ctxG.fillStyle = '#A0522D'; ctxG.fillRect(2,2,28,28); // Ø±ÙˆØ´Ù†â€ŒØªØ±
        ctxG.fillStyle = '#5D4037'; ctxG.fillRect(0,0,32,2); ctxG.fillRect(0,0,2,32); // Ù…Ø±Ø²
        document.getElementById('ground').style.backgroundImage = `url(${canvasG.toDataURL()})`;
        
        // 2. ØªÙˆÙ„ÛŒØ¯ Ø¨Ø§Ø²ÛŒÚ©Ù† (Ù¾ÛŒÚ©Ø³Ù„ÛŒ)
        const canvasP = document.createElement('canvas'); canvasP.width = 40; canvasP.height = 40;
        const ctxP = canvasP.getContext('2d');
        // Ú©Ù„Ø§Ù‡ Ø¢Ø¨ÛŒ
        ctxP.fillStyle = '#e74c3c'; ctxP.fillRect(10, 10, 20, 20); // Ø¨Ø¯Ù† Ù‚Ø±Ù…Ø²
        ctxP.fillStyle = '#3498db'; ctxP.fillRect(10, 5, 20, 8); // Ú©Ù„Ø§Ù‡
        ctxP.fillStyle = '#ffccaa'; ctxP.fillRect(12, 12, 14, 10); // ØµÙˆØ±Øª
        ctxP.fillStyle = '#000'; ctxP.fillRect(20, 15, 2, 2); // Ú†Ø´Ù…
        document.getElementById('player').style.backgroundImage = `url(${canvasP.toDataURL()})`;

        // 3. Ø§Ø³ØªØ§ÛŒÙ„ Ù…ÙˆØ§Ù†Ø¹ Ùˆ Ù‚Ù„Ø¨ (Ø¯Ø± Ø²Ù…Ø§Ù† ØªÙˆÙ„ÛŒØ¯)
        window.brickUrl = canvasG.toDataURL(); // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ù…ÙˆØ§Ù†Ø¹
    }
    // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø±Ø§ÙÛŒÚ©
    generateAssets();

    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø²ÛŒ Ùˆ Ø¨Ù„Ø§Ú©Ú†ÛŒÙ† ---
    const CONTRACT_ADDRESS = "0xabE3d632dcc93E5D077Fb176a18818867cB39428"; 
    const BASE_PRICE = 0.00001; 
    const SONEIUM_CHAIN_ID = '0x79A';
    const SONEIUM_RPC_URL = 'https://rpc.minato.soneium.org/';
    const CONTRACT_ABI = ["function submitScore(uint256 score, uint256 multiplier) public payable", "function getProjectStatus() public view returns (uint256, uint256, string, uint256)"];

    const player = document.getElementById('player');
    const gameContainer = document.getElementById('gameContainer');
    const scoreBoard = document.getElementById('scoreBoard');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const successScreen = document.getElementById('successScreen');
    const multiplierSlider = document.getElementById('multiplierSlider');
    const multiplierValue = document.getElementById('multiplierValue');
    const finalRankScore = document.getElementById('finalRankScore');
    const ethCost = document.getElementById('ethCost');
    const payBtn = document.getElementById('payBtn');
    const raisedFundsDisplay = document.getElementById('raisedFundsDisplay');
    const finalBricks = document.getElementById('finalBricks');
    const finalHearts = document.getElementById('finalHearts');

    let isGameRunning = false, bricks = 0, hearts = 0, totalScore = 0;
    let playerBottom = 96, jumpSpeed = 0, obstacles = [], collectibles = [], gameLoopId, spawnerId;

    async function switchToSoneium() {
        if (typeof window.ethereum === 'undefined') return;
        try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SONEIUM_CHAIN_ID }], }); } 
        catch (e) {
            if (e.code === 4902) {
                try { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: SONEIUM_CHAIN_ID, chainName: 'Soneium Minato Testnet', rpcUrls: [SONEIUM_RPC_URL], nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }, blockExplorerUrls: ['https://explorer-testnet.soneium.org/'] }], }); } catch (ee) {}
            }
        }
    }

    window.onload = async function() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const status = await contract.getProjectStatus();
                raisedFundsDisplay.innerText = parseFloat(ethers.utils.formatEther(status[1])).toFixed(4) + " ETH";
            } catch(e) {}
        }
    };

    gameContainer.addEventListener('mousedown', jump);
    gameContainer.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
    document.addEventListener('keydown', (e) => { if(e.code === 'Space') jump(); });

    function startGame(e) {
        if(e) e.stopPropagation();
        clearInterval(gameLoopId); clearInterval(spawnerId);
        isGameRunning = true; bricks = 0; hearts = 0;
        obstacles.forEach(ob => ob.element.remove()); obstacles = [];
        collectibles.forEach(c => c.element.remove()); collectibles = [];
        startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden'); successScreen.classList.add('hidden');
        playerBottom = 96; player.style.bottom = '96px'; 
        updateScoreBoard();
        gameLoopId = setInterval(gameLoop, 20); 
        spawnerId = setInterval(spawnManager, 1500);
    }

    function jump() { if (isGameRunning && playerBottom <= 100) jumpSpeed = 15; }

    function spawnManager() {
        if (!isGameRunning) return;
        const rand = Math.random();
        if (rand < 0.6) createObstacle();
        else if (rand < 0.9) createCollectible();
    }

    function createObstacle() {
        const obstacle = document.createElement('div');
        obstacle.classList.add('obstacle');
        obstacle.style.left = '450px';
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±Ø§ÙÛŒÚ© ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡
        obstacle.style.backgroundImage = `url(${window.brickUrl})`;
        gameContainer.appendChild(obstacle);
        obstacles.push({ element: obstacle, pos: 450, passed: false });
    }

    function createCollectible() {
        const item = document.createElement('div');
        item.classList.add('collectible');
        // Ù‚Ù„Ø¨ Ø±Ø§ Ø¨Ø§ SVG Ø³Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… Ú©Ù‡ Ø´ÙØ§Ù Ùˆ Ø²ÛŒØ¨Ø§ Ø¨Ø§Ø´Ø¯
        item.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e74c3c'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E")`;
        item.style.left = '450px';
        const height = Math.random() > 0.5 ? 120 : 180; 
        item.style.bottom = height + 'px';
        gameContainer.appendChild(item);
        collectibles.push({ element: item, pos: 450, bottom: height });
    }

    function gameLoop() {
        if (playerBottom > 96 || jumpSpeed > 0) { playerBottom += jumpSpeed; jumpSpeed -= 0.8
