<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homa - Build to Impact</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        body {
            margin: 0; padding: 0; background-color: #202020;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; font-family: 'VT323', 'Arial', sans-serif;
            overflow: hidden; color: white; user-select: none;
        }
        #gameContainer {
            position: relative; width: 100%; max-width: 400px; height: 600px;
            /* ØªØµÙˆÛŒØ± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø´Ù…Ø§ */
            background-image: url('Background.png');
            background-size: cover;
            background-position: center;
            overflow: hidden; border: 4px solid #333; border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7); image-rendering: pixelated;
        }
        #projectStatus {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(108, 92, 231, 0.9); color: #fff;
            padding: 8px 0; text-align: center; font-size: 16px; z-index: 15;
            border-bottom: 3px solid #fab1a0;
        }
        #scoreBoard {
            position: absolute; top: 50px; left: 20px;
            font-size: 28px; font-weight: bold; color: #fff; z-index: 10;
            text-shadow: 2px 2px 0 #6c5ce7;
        }
        #startScreen, #gameOverScreen, #successScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(45, 52, 54, 0.9); display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; text-align: center; backdrop-filter: blur(5px);
        }
        .panel {
            background: #dfe6e9; color: #2d3436; padding: 25px;
            border: 4px solid #6c5ce7; width: 80%; max-width: 300px;
            border-radius: 15px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.3); animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        h1 { margin: 0 0 10px 0; color: #fab1a0; text-shadow: 3px 3px 0 #6c5ce7; font-size: 48px; }
        button.action-btn {
            background: #6c5ce7; border: 3px solid #fff; padding: 10px 25px; color: white;
            font-size: 24px; cursor: pointer; margin-top: 15px; width: 100%; 
            font-weight: bold; font-family: 'VT323', sans-serif; border-radius: 10px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2); transition: all 0.05s;
        }
        button.action-btn:active { transform: translate(4px, 4px); box-shadow: 0 0 0 #000; }
        .hidden { display: none !important; }

        /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø±Ø§Ú©ØªØ± Ø®Ø±Ø³ --- */
        #player {
            position: absolute; width: 50px; height: 50px; bottom: 80px; left: 50px; z-index: 5;
            background-image: url('Teddy_Bear.png');
            background-repeat: no-repeat; background-size: contain;
            /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø§Ù„Ø§ Ù¾Ø§ÛŒÛŒÙ† Ù¾Ø±ÛŒØ¯Ù† Ø¨Ø±Ø§ÛŒ Ø§Ù„Ù‚Ø§ÛŒ Ø¯ÙˆÛŒØ¯Ù† */
            animation: run-bob 0.2s infinite alternate;
        }
        .jump-anim { animation: jump-rotate 0.5s ease-out !important; }
        @keyframes run-bob { from { transform: translateY(0); } to { transform: translateY(-3px); } }
        @keyframes jump-rotate { 
            0% { transform: translateY(0) rotate(0deg); } 
            50% { transform: translateY(-20px) rotate(10deg); }
            100% { transform: translateY(0) rotate(0deg); } 
        }

        /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…ÙˆØ§Ù†Ø¹ --- */
        .obstacle {
            position: absolute; width: 40px; height: 60px; bottom: 85px; z-index: 4;
            background-repeat: no-repeat; background-size: contain;
            /* Ø¹Ú©Ø³ Ù…Ø§Ù†Ø¹ Ø¯Ø± Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
        }
        
        .collectible {
            position: absolute; width: 32px; height: 32px; z-index: 4;
            background-repeat: no-repeat; background-size: contain;
            animation: float 0.8s infinite alternate; filter: drop-shadow(0 0 5px gold);
        }
        @keyframes float { from { transform: translateY(0); } to { transform: translateY(-8px); } }

        /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø²Ù…ÛŒÙ† --- */
        #ground {
            position: absolute; bottom: 0; width: 100%; height: 100px; z-index: 3;
            background-image: url('Foreground.png');
            background-repeat: repeat-x; 
            background-size: auto 100%;
        }
        
        .donation-control { margin: 15px 0; text-align: center; }
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #6c5ce7; }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="projectStatus">
        ğŸ—ï¸ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø¯Ø±Ø³Ù‡: <b>ÙØ§Ø² Û± - ÙÙˆÙ†Ø¯Ø§Ø³ÛŒÙˆÙ†</b><br>
        Ù¾ÛŒØ´Ø±ÙØª: <span id="raisedFundsDisplay" style="color:#55efc4">Loading...</span> / 0.5 ETH
    </div>
    
    <div id="scoreBoard">ğŸ’ 0 <span style="font-size:20px; margin-right:10px;">(â¤ï¸ 0)</span></div>
    
    <div id="startScreen">
        <h1>HOMA RUNNER</h1>
        <p style="color:#fff; font-size: 20px; text-shadow: 2px 2px 0 #000;">Pixel Art Edition</p>
        <button class="action-btn" onclick="startGame(event)">START GAME</button>
    </div>

    <div id="gameOverScreen" class="hidden">
        <div class="panel">
            <h2>GAME OVER</h2>
            <div style="display:flex; justify-content:space-around; font-size: 24px;">
                <div>ğŸ’ <b id="finalBricks">0</b></div> <div>â¤ï¸ <b id="finalHearts">0</b></div>
            </div>
            <hr style="border: 2px solid #6c5ce7; margin: 10px 0;">
            <div class="donation-control">
                <label>Ø¶Ø±ÛŒØ¨ Ø¯ÙˆÙ†ÛŒØ´Ù†: <span id="multiplierValue" style="color:#d63031; font-weight:bold;">1x</span></label>
                <input type="range" id="multiplierSlider" min="1" max="100" value="1" oninput="updateDonationCalc()">
                <div style="font-size: 14px; margin-top:5px;">Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ:</div>
                <div id="finalRankScore" style="font-size: 28px; font-weight: bold; color:#d63031;">0</div>
                <span style="font-size: 14px; color: #555;">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ (ETH):</span>
                <div id="ethCost" style="font-weight:bold; color:#00b894;">0.00001</div>
            </div>
            <button id="payBtn" class="action-btn" style="background: #00b894;" onclick="processPayment()">PAY & RANK UP</button>
            <button onclick="startGame(event)" style="background:none; border:none; color:#2d3436; margin-top:10px; cursor:pointer; text-decoration:underline; font-family: 'VT323'; font-size: 20px;">TRY AGAIN</button>
        </div>
    </div>

    <div id="successScreen" class="hidden">
        <div class="panel">
            <div style="font-size: 50px;">ğŸ‰</div>
            <h3>SUCCESS!</h3>
            <p>ØªØ±Ø§Ú©Ù†Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.</p>
            <button class="action-btn" style="background: #00b894;" onclick="reloadGame()">CONTINUE</button>
        </div>
    </div>

    <div id="player"></div>
    <div id="ground"></div>
</div>

<script type="module">
    import sdk from 'https://esm.sh/@farcaster/frame-sdk';
    try { sdk.actions.ready(); } catch(e) { console.log("SDK Local Error:", e); }
</script>

<script>
    // --- Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ§Ù†Ø¹ (Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§ Ù‡Ù…ÛŒÙ† Ø§Ø³Ù…â€ŒÙ‡Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ø´ÙˆÙ†Ø¯) ---
    const obstacleImages = ['Obstacle_1.png', 'Obstacle_2.png', 'Obstacle_3.png'];

    const CONTRACT_ADDRESS = "0xabE3d632dcc93E5D077Fb176a18818867cB39428"; 
    const BASE_PRICE = 0.00001; 
    const SONEIUM_CHAIN_ID = '0x79A';
    const SONEIUM_RPC_URL = 'https://rpc.minato.soneium.org/';
    const CONTRACT_ABI = ["function submitScore(uint256 score, uint256 multiplier) public payable", "function getProjectStatus() public view returns (uint256, uint256, string, uint256)"];

    const player = document.getElementById('player');
    const gameContainer = document.getElementById('gameContainer');
    const scoreBoard = document.getElementById('scoreBoard');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const successScreen = document.getElementById('successScreen');
    const multiplierSlider = document.getElementById('multiplierSlider');
    const multiplierValue = document.getElementById('multiplierValue');
    const finalRankScore = document.getElementById('finalRankScore');
    const ethCost = document.getElementById('ethCost');
    const payBtn = document.getElementById('payBtn');
    const raisedFundsDisplay = document.getElementById('raisedFundsDisplay');
    const finalBricks = document.getElementById('finalBricks');
    const finalHearts = document.getElementById('finalHearts');

    let isGameRunning = false, bricks = 0, hearts = 0, totalScore = 0;
    let playerBottom = 80, jumpSpeed = 0, obstacles = [], collectibles = [], gameLoopId, spawnerId;

    async function switchToSoneium() {
        if (typeof window.ethereum === 'undefined') return;
        try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SONEIUM_CHAIN_ID }], }); } 
        catch (e) {
            if (e.code === 4902) {
                try { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: SONEIUM_CHAIN_ID, chainName: 'Soneium Minato Testnet', rpcUrls: [SONEIUM_RPC_URL], nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }, blockExplorerUrls: ['https://explorer-testnet.soneium.org/'] }], }); } catch (ee) {}
            }
        }
    }

    window.onload = async function() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const status = await contract.getProjectStatus();
                raisedFundsDisplay.innerText = parseFloat(ethers.utils.formatEther(status[1])).toFixed(4) + " ETH";
            } catch(e) {}
        }
    };

    gameContainer.addEventListener('mousedown', jump);
    gameContainer.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
    document.addEventListener('keydown', (e) => { if(e.code === 'Space') jump(); });

    function startGame(e) {
        if(e) e.stopPropagation();
        clearInterval(gameLoopId); clearInterval(spawnerId);
        isGameRunning = true; bricks = 0; hearts = 0;
        obstacles.forEach(ob => ob.element.remove()); obstacles = [];
        collectibles.forEach(c => c.element.remove()); collectibles = [];
        startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden'); successScreen.classList.add('hidden');
        playerBottom = 80; player.style.bottom = '80px'; 
        player.classList.remove('jump-anim');
        updateScoreBoard();
        gameLoopId = setInterval(gameLoop, 20); 
        spawnerId = setInterval(spawnManager, 1500);
    }

    function jump() { 
        if (isGameRunning && playerBottom <= 85) {
            jumpSpeed = 16;
            player.classList.add('jump-anim');
            setTimeout(() => player.classList.remove('jump-anim'), 500);
        }
    }

    function spawnManager() {
        if (!isGameRunning) return;
        const rand = Math.random();
        if (rand < 0.6) createObstacle();
        else if (rand < 0.9) createCollectible();
    }

    function createObstacle() {
        const obstacle = document.createElement('div');
        obstacle.classList.add('obstacle');
        // Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§Ø¯ÙÛŒ ÛŒÚ©ÛŒ Ø§Ø² Û³ Ø¹Ú©Ø³ Ù…Ø§Ù†Ø¹ Ø´Ù…Ø§
        const randomImg = obstacleImages[Math.floor(Math.random() * obstacleImages.length)];
        obstacle.style.backgroundImage = `url('${randomImg}')`;
        obstacle.style.left = '450px';
        gameContainer.appendChild(obstacle);
        obstacles.push({ element: obstacle, pos: 450, passed: false });
    }

    function createCollectible() {
        const item = document.createElement('div');
        item.classList.add('collectible');
        // Ø¨Ø±Ø§ÛŒ Ù‚Ù„Ø¨ ÙØ¹Ù„Ø§ Ø§Ø² SVG Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ… Ú†ÙˆÙ† ÙØ§ÛŒÙ„ Ù‚Ù„Ø¨ Ø±Ø§ Ù†ÙØ±Ø³ØªØ§Ø¯ÛŒØ¯ØŒ Ø§Ù…Ø§ Ø§Ú¯Ø± Ø¯Ø§Ø±ÛŒØ¯ ÙØ§ÛŒÙ„Ø´ Ø±Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯
        item.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23d63031'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E")`;
        item.style.left = '450px';
        const height = Math.random() > 0.5 ? 120 : 180; 
        item.style.bottom = height + 'px';
        gameContainer.appendChild(item);
        collectibles.push({ element: item, pos: 450, bottom: height });
    }

    function gameLoop() {
        if (playerBottom > 80 || jumpSpeed > 0) { playerBottom += jumpSpeed; jumpSpeed -= 0.8; }
        else { jumpSpeed = 0; playerBottom = 80; }
        player.style.bottom = playerBottom + 'px';

        obstacles.forEach((ob, index) => {
            ob.pos -= 6; ob.element.style.left = ob.pos + 'px';
            if (ob.pos < -50) { ob.element.remove(); obstacles.splice(index, 1); }
            if (ob.pos < 50 && !ob.passed) { bricks++; updateScoreBoard(); ob.passed = true; }
            if (ob.pos > 10 && ob.pos < 60 && playerBottom < 125) gameOver();
        });

        collectibles.forEach((c, index) => {
            c.pos -= 6; c.element.style.left = c.pos + 'px';
            if (c.pos < -50) { c.element.remove(); collectibles.splice(index, 1); }
            if (c.pos > 10 && c.pos < 70 && playerBottom + 40 >= c.bottom && playerBottom <= c.bottom + 40) {
                hearts += 5; c.element.style.backgroundImage = "none"; c.element.innerText = "âœ¨"; c.element.style.fontSize = "30px";
                setTimeout(() => c.element.remove(), 200);
                collectibles.splice(index, 1);
                updateScoreBoard();
            }
        });
    }

    function updateScoreBoard() { scoreBoard.innerHTML = `ğŸ’ ${bricks} <span style="font-size:20px; margin-right:10px;">(â¤ï¸ ${hearts})</span>`; }

    function gameOver() {
        isGameRunning = false; clearInterval(gameLoopId); clearInterval(spawnerId);
        totalScore = bricks + hearts; finalBricks.innerText = bricks; finalHearts.innerText = hearts;
        updateDonationCalc(); gameOverScreen.classList.remove('hidden');
    }

    function updateDonationCalc() {
        const m = parseInt(multiplierSlider.value); multiplierValue.innerText = m + "x";
        finalRankScore.innerText = totalScore * m; ethCost.innerText = (totalScore * m * BASE_PRICE).toFixed(5);
    }

    async function processPayment() {
        if(totalScore === 0) return alert("Ø§Ù…ØªÛŒØ§Ø² ØµÙØ± Ø§Ø³Øª!");
        if (typeof window.ethereum === 'undefined') return alert("Ù„Ø·ÙØ§Ù‹ Ú©ÛŒÙ Ù¾ÙˆÙ„ Web3 Ù†ØµØ¨ Ú©Ù†ÛŒØ¯!");
        try {
            payBtn.innerText = "â³ Network..."; payBtn.disabled = true;
            await switchToSoneium();
            payBtn.innerText = "â³ Paying...";
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            const m = parseInt(multiplierSlider.value);
            const cost = ethers.utils.parseEther((totalScore * m * BASE_PRICE).toFixed(5).toString());
            const tx = await contract.submitScore(totalScore, m, { value: cost });
            await tx.wait();
            successScreen.classList.remove('hidden'); gameOverScreen.classList.add('hidden');
            payBtn.innerText = "PAY & RANK UP"; payBtn.disabled = false;
        } catch (e) { console.error(e); alert("Error: " + e.message); payBtn.innerText = "PAY & RANK UP"; payBtn.disabled = false; }
    }
    window.reloadGame = function() { location.reload(); }
</script>
</body>
</html>
