<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homa - Build to Impact</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #0d1117;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; font-family: 'Arial', sans-serif;
            overflow: hidden; color: white; user-select: none;
        }
        #gameContainer {
            position: relative; width: 100%; max-width: 400px; height: 600px;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            overflow: hidden; border: 2px solid #333; border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #projectStatus {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); color: #fff;
            padding: 8px 0; text-align: center; font-size: 12px; z-index: 15;
            border-bottom: 2px solid #FFD700;
        }
        #scoreBoard {
            position: absolute; top: 40px; left: 20px;
            font-size: 24px; font-weight: bold; color: #333; z-index: 10;
            text-shadow: 2px 2px 0px #fff;
            background: rgba(255,255,255,0.5); padding: 5px 10px; border-radius: 10px;
        }
        #startScreen, #gameOverScreen, #successScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; text-align: center; backdrop-filter: blur(5px);
        }
        .panel {
            background: white; color: #333; padding: 20px;
            border-radius: 15px; width: 80%; max-width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        h1 { margin: 0 0 10px 0; color: #FFD700; text-shadow: 2px 2px 0px #000; font-size: 32px; }
        button.action-btn {
            background: linear-gradient(45deg, #FF4500, #FF8C00);
            border: none; padding: 12px 25px; color: white;
            font-size: 18px; border-radius: 25px; cursor: pointer;
            margin-top: 10px; width: 100%; font-weight: bold;
            box-shadow: 0 4px #c0392b; transition: all 0.1s;
        }
        button.action-btn:active { transform: translateY(2px); box-shadow: 0 2px #c0392b; }
        button.success-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); box-shadow: 0 4px #1e8449; }
        .donation-control { margin: 15px 0; text-align: center; }
        input[type=range] { width: 100%; margin: 10px 0; }
        .price-tag { background: #E8F5E9; color: #2E7D32; padding: 5px 10px; border-radius: 5px; font-weight: bold; display: block; margin-top: 5px;}
        .hidden { display: none !important; }

        /* --- Ø§ØµÙ„Ø§Ø­Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ø¨Ù‡ØªØ± --- */
        #player {
            position: absolute; width: 40px; height: 40px;
            bottom: 100px; left: 50px;
            font-size: 30px; line-height: 40px; text-align: center;
            background: rgba(255, 255, 255, 0.8); /* Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ø³ÙÛŒØ¯ Ø´ÙØ§Ù */
            border: 2px solid #333; /* Ø®Ø· Ø¯ÙˆØ± */
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .obstacle {
            position: absolute; width: 40px; height: 40px; bottom: 100px;
            font-size: 30px; line-height: 40px; text-align: center;
            background: #5D4037; /* Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ø¢Ø¬Ø± */
            border: 2px solid #3E2723;
            border-radius: 5px;
            color: white; /* Ø§Ú¯Ø± Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ù„ÙˆØ¯ Ù†Ø´Ø¯ */
        }
        .collectible {
            position: absolute; width: 40px; height: 40px;
            font-size: 35px; line-height: 40px; text-align: center;
            animation: float 0.8s infinite alternate;
            filter: drop-shadow(0 0 5px gold); /* Ø¯Ø±Ø®Ø´Ø´ Ø¯ÙˆØ± Ù‚Ù„Ø¨ */
        }
        @keyframes float { from { transform: translateY(0); } to { transform: translateY(-8px); } }

        #ground {
            position: absolute; bottom: 0; width: 100%; height: 100px;
            background-color: #4CAF50; border-top: 6px solid #2E7D32;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 20px, #388E3C 20px, #388E3C 40px);
        }
        .cloud {
            position: absolute; color: rgba(255,255,255,0.8); font-size: 60px;
            top: 50px; animation: moveClouds 15s linear infinite; opacity: 0.8;
        }
        @keyframes moveClouds { from { left: 450px; } to { left: -150px; } }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="projectStatus">
        ğŸ—ï¸ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø¯Ø±Ø³Ù‡: <b>ÙØ§Ø² Û± - ÙÙˆÙ†Ø¯Ø§Ø³ÛŒÙˆÙ†</b><br>
        Ù¾ÛŒØ´Ø±ÙØª Ø¨ÙˆØ¯Ø¬Ù‡: <span id="raisedFundsDisplay" style="color:#4CAF50">Loading...</span> / 0.5 ETH
    </div>

    <div class="cloud" style="top:20px; animation-duration: 18s;">â˜ï¸</div>
    <div class="cloud" style="top:70px; animation-duration: 14s; animation-delay: 6s; font-size: 40px;">â˜ï¸</div>

    <div id="scoreBoard">ğŸ§± 0 <span style="font-size:16px; margin-right:10px;">(â¤ï¸ 0)</span></div>
    
    <div id="startScreen">
        <h1>HOMA RUNNER</h1>
        <p style="color:#eee; font-weight:bold; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:10px;">ğŸ‘·â€â™‚ï¸ Ø¨Ø¯Ùˆ Ùˆ Ù…Ø¯Ø±Ø³Ù‡ Ø¨Ø³Ø§Ø²!</p>
        <button class="action-btn" onclick="startGame(event)">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
    </div>

    <div id="gameOverScreen" class="hidden">
        <div class="panel">
            <h2>Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ!</h2>
            <div style="display:flex; justify-content:space-around; margin-bottom:10px;">
                <div>ğŸ§± Ø¢Ø¬Ø±: <b id="finalBricks">0</b></div>
                <div>â¤ï¸ Ù‚Ù„Ø¨: <b id="finalHearts">0</b></div>
            </div>
            
            <hr style="border: 1px solid #eee; margin: 10px 0;">
            <div class="donation-control">
                <label>Ø¶Ø±ÛŒØ¨ Ø¯ÙˆÙ†ÛŒØ´Ù†: <span id="multiplierValue" style="color:#2980b9; font-weight:bold;">1x</span></label>
                <input type="range" id="multiplierSlider" min="1" max="100" value="1" oninput="updateDonationCalc()">
                <div style="font-size: 12px; margin-top:5px;">Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ (Ø¢Ø¬Ø± + Ù‚Ù„Ø¨):</div>
                <div id="finalRankScore" style="font-size: 22px; font-weight: bold; color:#d35400;">0</div>
                <span class="price-tag">Ù…Ø¨Ù„Øº: <span id="ethCost">0.00001</span> ETH</span>
            </div>
            <button id="payBtn" class="action-btn" style="background: linear-gradient(45deg, #27ae60, #2ecc71);" onclick="processPayment()">
                â¤ï¸ Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯
            </button>
            <button onclick="startGame(event)" style="background:none; border:none; color:#777; margin-top:10px; cursor:pointer; text-decoration:underline;">Ø¨Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯</button>
        </div>
    </div>

    <div id="successScreen" class="hidden">
        <div class="panel">
            <div style="font-size: 50px;">ğŸ‰</div>
            <h3>ØªØ±Ø§Ú©Ù†Ø´ Ù…ÙˆÙÙ‚!</h3>
            <p style="font-size: 14px; color: #555;">Ú©Ù…Ú© Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.</p>
            <button class="action-btn success-btn" onclick="reloadGame()">Ø§Ø¯Ø§Ù…Ù‡</button>
        </div>
    </div>

    <div id="player">ğŸ‘·â€â™‚ï¸</div>
    <div id="ground"></div>
</div>

<script type="module">
    import sdk from 'https://esm.sh/@farcaster/frame-sdk';
    sdk.actions.ready();
</script>

<script>
    const CONTRACT_ADDRESS = "0xabE3d632dcc93E5D077Fb176a18818867cB39428"; 
    const BASE_PRICE = 0.00001; 
    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ø¨Ú©Ù‡ Soneium Minato
    const SONEIUM_CHAIN_ID = '0x79A'; // 1946 Ø¨Ù‡ Ù‡Ú¯Ø²
    const SONEIUM_RPC_URL = 'https://rpc.minato.soneium.org/';
    
    const CONTRACT_ABI = [
        "function submitScore(uint256 score, uint256 multiplier) public payable",
        "function getProjectStatus() public view returns (uint256, uint256, string, uint256)"
    ];

    const player = document.getElementById('player');
    const gameContainer = document.getElementById('gameContainer');
    const scoreBoard = document.getElementById('scoreBoard');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const successScreen = document.getElementById('successScreen');
    const multiplierSlider = document.getElementById('multiplierSlider');
    const multiplierValue = document.getElementById('multiplierValue');
    const finalRankScore = document.getElementById('finalRankScore');
    const ethCost = document.getElementById('ethCost');
    const payBtn = document.getElementById('payBtn');
    const raisedFundsDisplay = document.getElementById('raisedFundsDisplay');
    const finalBricks = document.getElementById('finalBricks');
    const finalHearts = document.getElementById('finalHearts');

    let isGameRunning = false, bricks = 0, hearts = 0, totalScore = 0;
    let playerBottom = 100, jumpSpeed = 0, obstacles = [], collectibles = [], gameLoopId, spawnerId;

    // ØªØ§Ø¨Ø¹ ØªØ¹ÙˆÛŒØ¶ Ø´Ø¨Ú©Ù‡ (Ø¬Ø¯ÛŒØ¯)
    async function switchToSoneium() {
        if (typeof window.ethereum === 'undefined') return;
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: SONEIUM_CHAIN_ID }],
            });
        } catch (switchError) {
            // Ø§Ú¯Ø± Ø´Ø¨Ú©Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø¢Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: SONEIUM_CHAIN_ID,
                            chainName: 'Soneium Minato Testnet',
                            rpcUrls: [SONEIUM_RPC_URL],
                            nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                            blockExplorerUrls: ['https://explorer-testnet.soneium.org/']
                        }],
                    });
                } catch (addError) {
                    console.error("Error adding chain:", addError);
                }
            } else {
                console.error("Error switching chain:", switchError);
            }
        }
    }

    window.onload = async function() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                // Ø³Ø¹ÛŒ Ú©Ù† Ø´Ø¨Ú©Ù‡ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒ Ø§Ù…Ø§ Ø§Ú¯Ø± Ù†Ø´Ø¯ Ù…Ù‡Ù… Ù†ÛŒØ³ØªØŒ Ù…ÙˆÙ‚Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ø²ÙˆØ± Ù…ÛŒÚ©Ù†ÛŒÙ…
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const status = await contract.getProjectStatus();
                raisedFundsDisplay.innerText = parseFloat(ethers.utils.formatEther(status[1])).toFixed(4) + " ETH";
            } catch(e) {}
        }
    };

    gameContainer.addEventListener('mousedown', jump);
    gameContainer.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
    document.addEventListener('keydown', (e) => { if(e.code === 'Space') jump(); });

    function startGame(e) {
        if(e) e.stopPropagation();
        clearInterval(gameLoopId); clearInterval(spawnerId);
        isGameRunning = true; bricks = 0; hearts = 0;
        obstacles.forEach(ob => ob.element.remove()); obstacles = [];
        collectibles.forEach(c => c.element.remove()); collectibles = [];
        startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden'); successScreen.classList.add('hidden');
        playerBottom = 100; player.style.bottom = '100px'; 
        updateScoreBoard();
        gameLoopId = setInterval(gameLoop, 20); 
        spawnerId = setInterval(spawnManager, 1500);
    }

    function jump() { if (isGameRunning && playerBottom <= 105) jumpSpeed = 15; }

    function spawnManager() {
        if (!isGameRunning) return;
        const rand = Math.random();
        if (rand < 0.6) createObstacle();
        else if (rand < 0.9) createCollectible();
    }

    function createObstacle() {
        const obstacle = document.createElement('div');
        obstacle.classList.add('obstacle');
        obstacle.innerText = Math.random() > 0.5 ? 'ğŸ§±' : 'ğŸª¨';
        obstacle.style.left = '450px';
        gameContainer.appendChild(obstacle);
        obstacles.push({ element: obstacle, pos: 450, passed: false });
    }

    function createCollectible() {
        const item = document.createElement('div');
        item.classList.add('collectible');
        item.innerText = 'â¤ï¸';
        item.style.left = '450px';
        const height = Math.random() > 0.5 ? 120 : 180; 
        item.style.bottom = height + 'px';
        gameContainer.appendChild(item);
        collectibles.push({ element: item, pos: 450, bottom: height });
    }

    function gameLoop() {
        if (playerBottom > 100 || jumpSpeed > 0) { playerBottom += jumpSpeed; jumpSpeed -= 0.8; }
        else { jumpSpeed = 0; playerBottom = 100; }
        player.style.bottom = playerBottom + 'px';

        obstacles.forEach((ob, index) => {
            ob.pos -= 6; ob.element.style.left = ob.pos + 'px';
            if (ob.pos < -50) { ob.element.remove(); obstacles.splice(index, 1); }
            if (ob.pos < 50 && !ob.passed) { bricks++; updateScoreBoard(); ob.passed = true; }
            if (ob.pos > 20 && ob.pos < 80 && playerBottom < 135) gameOver();
        });

        collectibles.forEach((c, index) => {
            c.pos -= 6; c.element.style.left = c.pos + 'px';
            if (c.pos < -50) { c.element.remove(); collectibles.splice(index, 1); }
            if (c.pos > 20 && c.pos < 80 && playerBottom + 40 >= c.bottom && playerBottom <= c.bottom + 40) {
                hearts += 5; c.element.innerText = "âœ¨"; 
                setTimeout(() => c.element.remove(), 200);
                collectibles.splice(index, 1);
                updateScoreBoard();
            }
        });
    }

    function updateScoreBoard() {
        scoreBoard.innerHTML = `ğŸ§± ${bricks} <span style="font-size:16px; margin-right:10px;">(â¤ï¸ ${hearts})</span>`;
    }

    function gameOver() {
        isGameRunning = false; clearInterval(gameLoopId); clearInterval(spawnerId);
        totalScore = bricks + hearts;
        finalBricks.innerText = bricks; finalHearts.innerText = hearts;
        updateDonationCalc(); 
        gameOverScreen.classList.remove('hidden');
    }

    function updateDonationCalc() {
        const m = parseInt(multiplierSlider.value); multiplierValue.innerText = m + "x";
        finalRankScore.innerText = totalScore * m; 
        ethCost.innerText = (totalScore * m * BASE_PRICE).toFixed(5);
    }

    async function processPayment() {
        if(totalScore === 0) return alert("Ø§Ù…ØªÛŒØ§Ø² ØµÙØ± Ø§Ø³Øª!");
        if (typeof window.ethereum === 'undefined') return alert("Ù„Ø·ÙØ§Ù‹ Ú©ÛŒÙ Ù¾ÙˆÙ„ Web3 Ù†ØµØ¨ Ú©Ù†ÛŒØ¯!");
        
        try {
            payBtn.innerText = "â³ ØªØºÛŒÛŒØ± Ø´Ø¨Ú©Ù‡...";
            payBtn.disabled = true;

            // 1. Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ¹ÙˆÛŒØ¶ Ø´Ø¨Ú©Ù‡ Ø¨Ù‡ Ø³ÙˆÙ†ÛŒÙˆÙ…
            await switchToSoneium();

            payBtn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª...";
            
            // 2. Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø¢ÛŒÙ†Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            const m = parseInt(multiplierSlider.value);
            const cost = ethers.utils.parseEther((totalScore * m * BASE_PRICE).toFixed(5).toString());
            const tx = await contract.submitScore(totalScore, m, { value: cost });
            await tx.wait();
            
            successScreen.classList.remove('hidden'); gameOverScreen.classList.add('hidden');
            payBtn.innerText = "â¤ï¸ Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯"; payBtn.disabled = false;
        } catch (e) { 
            console.error(e);
            alert("Ø®Ø·Ø§: " + e.message); 
            payBtn.innerText = "â¤ï¸ Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯"; 
            payBtn.disabled = false; 
        }
    }
    
    window.reloadGame = function() { location.reload(); }
</script>
</body>
</html>
