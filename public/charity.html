<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homa Charity Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');

        :root {
            --bg-dark: #1a1b26; --card-bg: #24283b; --primary: #7aa2f7;
            --charity: #9ece6a; --lottery: #e0af68; --treasury: #7dcfff; --text: #c0caf5;
            --error: #f7768e;
        }

        body { margin: 0; padding: 0; background-color: var(--bg-dark); color: var(--text); font-family: 'Vazirmatn', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        header { padding: 15px; background: var(--card-bg); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .logo { font-weight: bold; font-size: 20px; color: var(--primary); }
        
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* STATS & TIMER */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .stat-box:active { transform: scale(0.98); }
        .stat-box:hover { background: rgba(255,255,255,0.1); }
        .stat-value { font-size: 18px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 12px; opacity: 0.7; }

        .timer-box { text-align: center; margin: 20px 0; }
        .countdown { font-size: 32px; font-weight: bold; color: var(--lottery); letter-spacing: 2px; }

        /* USER STATUS BOX */
        .user-status-box { background: rgba(122, 162, 247, 0.1); border: 1px solid var(--primary); padding: 10px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-stat-item { text-align: center; flex: 1; }
        .user-stat-val { font-weight: bold; color: #fff; font-size: 16px; }
        .user-stat-lbl { font-size: 10px; opacity: 0.7; }

        /* CONTROLS */
        .project-select { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); color: #fff; border: 1px solid #414868; border-radius: 10px; font-family: inherit; font-size: 14px; margin-bottom: 15px; outline: none; }
        .input-wrapper { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; border: 1px solid #414868; margin-bottom: 5px; }
        .currency-label { font-weight: bold; color: var(--primary); margin-right: 10px; }
        .amount-input { background: transparent; border: none; color: #fff; font-size: 24px; font-weight: bold; width: 100%; text-align: left; font-family: 'Vazirmatn', sans-serif; outline: none; }
        
        .usd-info { display: flex; justify-content: space-between; font-size: 12px; color: #737aa2; margin-bottom: 15px; padding: 0 5px; }
        input[type=range] { width: 100%; accent-color: var(--primary); margin: 10px 0; cursor: pointer; }
        
        .ticket-section { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .ticket-badge { background: var(--lottery); color: #000; padding: 5px 12px; border-radius: 12px; font-size: 14px; font-weight: bold; display: inline-block; transition: all 0.3s; }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; background: rgba(158, 206, 106, 0.1); padding: 10px; border-radius: 8px; border: 1px solid var(--charity); cursor: pointer; margin: 15px 0; }
        .checkbox-wrapper input { transform: scale(1.2); accent-color: var(--charity); }

        /* BUTTONS */
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; background: var(--primary); color: #fff; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { background: #414868; cursor: not-allowed; opacity: 0.7; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); padding: 5px 12px; font-size: 12px; border-radius: 8px; cursor: pointer; }
        .danger-btn { background: var(--error); border: none; width: 48%; padding: 10px; border-radius: 8px; color: #fff; cursor: pointer; }
        .success-btn { background: var(--charity); border: none; width: 48%; padding: 10px; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; }
        .tx-link { display:block; margin-top:10px; font-size:12px; color:var(--primary); text-decoration:underline; cursor: pointer;}

        /* DIST BAR */
        .dist-bar { height: 24px; border-radius: 12px; overflow: hidden; display: flex; background: #333; margin-top: 10px; }
        .bar-part { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #000; font-weight: 800; transition: width 0.5s ease; white-space: nowrap; overflow: hidden; text-transform: uppercase; }

        /* TABS & LISTS */
        .lb-tabs { display: flex; gap: 10px; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 10px; }
        .lb-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 8px; font-size: 13px; transition: 0.3s; color: #7aa2f7; }
        .lb-tab.active { background: #7aa2f7; color: #fff; font-weight: bold; }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s; }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item:last-child { border-bottom: none; }
        
        .rank { width: 25px; height: 25px; background: #333; border-radius: 50%; text-align: center; line-height: 25px; font-size: 12px; margin-left: 10px; }
        .rank-1 { background: var(--lottery); color: #000; }
        .user-addr { font-family: monospace; color: #9aa5ce; font-size: 14px; }
        
        .winners-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        .winners-table th { text-align: right; color: #7aa2f7; padding: 5px; border-bottom: 1px solid #444; }
        .winners-table td { padding: 8px 5px; border-bottom: 1px solid #333; }
        .rank-badge { display: inline-block; width: 20px; height: 20px; background: #444; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; }

        /* NAV & MODAL */
        .tab-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg); display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 90; }
        .tab-btn { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #565f89; transition: 0.2s; border-top: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-top-color: var(--primary); background: rgba(122, 162, 247, 0.1); }

        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid var(--primary); text-align: center; }
        .breakdown-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        
        .hidden { display: none; }
        .back-btn { display: inline-block; margin-bottom: 10px; color: var(--text); text-decoration: none; cursor: pointer; }
        .warning-msg { color: #ff9f43; font-size: 12px; display: none; margin-top: 5px; font-weight: bold; background: rgba(255, 159, 67, 0.1); padding: 8px; border-radius: 5px; }
        .social-links { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
        .social-icon { font-size: 24px; text-decoration: none; opacity: 0.8; transition: 0.2s; }
    </style>
</head>
<body>

<header>
    <div class="logo">ğŸ» HOMA Charity</div>
    <button id="connectBtn" class="btn-outline" onclick="connectWallet()">Connect Wallet</button>
</header>

<main>
    <div id="page-dashboard" class="page-section active">
        
        <div id="userStatusBox" class="user-status-box hidden">
            <div class="user-stat-item">
                <div class="user-stat-val" id="userTotalCents">0Â¢</div>
                <div class="user-stat-lbl">Ø§Ù†Ø¨Ø§Ø´Øª Ø´Ù…Ø§</div>
            </div>
            <div class="user-stat-item" style="border-right:1px solid #444; border-left:1px solid #444;">
                <div class="user-stat-val" id="userTickets">0</div>
                <div class="user-stat-lbl">Ø¨Ù„ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ù„Ø§ØªØ§Ø±ÛŒ</div>
            </div>
            <div class="user-stat-item">
                <div class="user-stat-val" id="userNeed">100Â¢</div>
                <div class="user-stat-lbl">ØªØ§ Ø¨Ù„ÛŒØ· Ø¨Ø¹Ø¯ÛŒ</div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box" style="border-bottom: 3px solid var(--charity);" onclick="showPage('projects')">
                <div class="stat-value" id="projectTotal">...</div>
                <div class="stat-label">Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ (Ú©Ù„ÛŒÚ©)</div>
            </div>
            <div class="stat-box" style="border-bottom: 3px solid var(--lottery);" onclick="showPage('lottery')">
                <div class="stat-value" id="potDisplay">Loading...</div>
                <div class="stat-label">Ø§Ø³ØªØ®Ø± Ù„Ø§ØªØ§Ø±ÛŒ (Ú©Ù„ÛŒÚ©)</div>
            </div>
        </div>

        <div class="card timer-box">
            <div style="font-size:12px; margin-bottom:5px;">Ø²Ù…Ø§Ù† ØªØ§ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø¨Ø¹Ø¯ÛŒ</div>
            <div class="countdown" id="timer">00:00:00</div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>Ù¾Ù†Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
                <span style="font-size:12px; color:#ffd700;">1 Ticket = $1 USD</span>
            </div>
            
            <select id="projectSelectMain" class="project-select">
                <option value="" disabled selected>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
            </select>

            <div class="input-wrapper">
                <span class="currency-label">ETH</span>
                <input type="number" id="amountInput" class="amount-input" step="0.0001" oninput="syncSlider(this.value)">
            </div>
            <div class="usd-info"><span id="usdDisplay">â‰ˆ $0.00</span><span id="ethPriceDisplay">...</span></div>
            <input type="range" id="amountSlider" min="0" max="0.1" step="0.0001" oninput="syncInput(this.value)">

            <div class="ticket-section">
                <span>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ù„ÛŒØ· Ø¯Ø±ÛŒØ§ÙØªÛŒ:</span>
                <span class="ticket-badge" id="ticketCount">ğŸŸï¸ 0</span>
            </div>
            
            <div id="minWarning" class="warning-msg" style="display:none;">
                âš ï¸ Ù…Ø¨Ù„Øº Ú©Ù…ØªØ± Ø§Ø² Û± Ø¯Ù„Ø§Ø± Ø§Ø³Øª. Ø§ÛŒÙ† Ù…Ø¨Ù„Øº Ø¯Ø± Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ <b>Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ù†Ø¨Ø§Ø´Øª</b> Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø¨Ù‡ Û± Ø¯Ù„Ø§Ø± Ø¨Ø±Ø³Ø¯.
            </div>

            <div class="dist-bar" id="distBar">
                <div class="bar-part" style="width:60%; background:var(--charity);">60% Charity</div>
                <div class="bar-part" style="width:30%; background:var(--lottery);">30% Pot</div>
                <div class="bar-part" style="width:10%; background:var(--treasury);">10% Team</div>
            </div>

            <label class="checkbox-wrapper">
                <input type="checkbox" id="charityOnly" onchange="togglePureCharity(this.checked)">
                <div><div style="font-weight:bold; color:var(--charity)">ÙÙ‚Ø· Ø®ÛŒØ±ÛŒÙ‡</div><div style="font-size:10px;">Û±Û°Û°Ùª Ø¨Ù‡ Ø®ÛŒØ±ÛŒÙ‡ (Ø¨Ø¯ÙˆÙ† Ù„Ø§ØªØ§Ø±ÛŒ)</div></div>
            </label>

            <button id="payBtn" class="action-btn" onclick="prepareDonation()">PAY & DONATE</button>
            
            <div id="successBox" style="display:none; margin-top:15px; padding:10px; background:rgba(158,206,106,0.2); border:1px solid var(--charity); border-radius:8px;">
                <div>âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚!</div>
                <a id="txLink" class="tx-link" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± Explorer â†—ï¸</a>
            </div>
        </div>
    </div>

    <div id="page-projects" class="page-section">
        <div onclick="showPage('dashboard')" class="back-btn">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</div>
        <div class="card">
            <h3>ğŸ“‚ Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</h3>
            <select id="projectSelectDetails" class="project-select" onchange="updateProjectInfo(this.value)">
                <option value="" disabled selected>Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
            </select>
            <div id="projectInfoBox" style="text-align:center; margin-top:20px;">
                <img src="https://placehold.co/300x150/24283b/FFF?text=Project+Info" style="border-radius:10px; width:100%; margin-bottom:10px;">
                <h2 id="pName">Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡</h2>
                <p id="pDesc" style="font-size:13px; opacity:0.8; margin-bottom:15px;">ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡</p>
                <div class="social-links">
                    <a href="#" id="lnkTele" class="social-icon">âœˆï¸</a>
                    <a href="#" id="lnkInsta" class="social-icon">ğŸ“·</a>
                </div>
            </div>
            <div style="margin-top:20px;"><h4>Ù„ÛŒØ³Øª ÙˆØ¶Ø¹ÛŒØª Ø¨ÙˆØ¯Ø¬Ù‡:</h4><div id="projectListContainer"></div></div>
        </div>
    </div>

    <div id="page-lottery" class="page-section">
        <div onclick="showPage('dashboard')" class="back-btn">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</div>
        <div class="card" style="text-align:center;">
            <h3>ğŸ° Ø§Ø³ØªØ®Ø± Ù„Ø§ØªØ§Ø±ÛŒ</h3>
            <div class="countdown" id="timerBig" style="font-size:40px; margin:20px 0;">00:00:00</div>
            <div style="font-size:14px; color:var(--lottery); margin-bottom:20px;">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ù„: <span id="bigPotDisplay">...</span> ETH</div>
            <h4 style="text-align:right; margin-bottom:10px;">ğŸ† ØªÙˆØ²ÛŒØ¹ Ø¬ÙˆØ§ÛŒØ²</h4>
            <table class="winners-table" id="winnersTable"><tr><td colspan="3">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</td></tr></table>
            <button class="action-btn" style="margin-top:20px; background:#e0af68; color:#000;" onclick="checkAndClaim()">Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯Ù† (Check)</button>
            <input type="hidden" id="winnerWallet">
        </div>
    </div>

    <div id="page-history" class="page-section">
        <div class="card"><h3>ğŸ“œ ØªØ§Ø±ÛŒØ®Ú†Ù‡</h3><div id="historyList"><p style="text-align:center; padding:20px;">Ù„Ø·ÙØ§Ù‹ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ ÙˆØµÙ„ Ú©Ù†ÛŒØ¯.</p></div></div>
    </div>

    <div id="page-leaderboard" class="page-section">
        <div class="card">
            <h3>ğŸ† Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§</h3>
            <div class="lb-tabs">
                <div class="lb-tab active" onclick="switchLbTab('global', this)">ğŸŒ Ú©Ù„ Ø§Ø¯ÙˆØ§Ø±</div>
                <div class="lb-tab" onclick="switchLbTab('round', this)">ğŸ”¥ Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
            </div>
            <div id="leaderList"><p style="text-align:center; padding:20px;">...</p></div>
        </div>
    </div>
</main>

<div id="confirmModal" class="modal hidden">
    <div class="modal-content">
        <h2>ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
        <div style="background:rgba(255,255,255,0.1); padding:10px; margin:20px 0; border-radius:8px;">
            <div id="modalTotalEth" style="font-size:20px; font-weight:bold;">0 ETH</div>
            <div id="modalTotalUsd" style="font-size:12px; opacity:0.8;">$0.00</div>
        </div>
        <div id="breakdownContainer"></div>
        <p style="color:#f7768e; font-size:10px; margin:15px 0;">âš ï¸ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª (Non-refundable)</p>
        <div style="display:flex; justify-content:space-between;">
            <button class="danger-btn" onclick="closeModal()">Ù„ØºÙˆ</button>
            <button class="success-btn" onclick="executeTransaction()">ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ</button>
        </div>
    </div>
</div>

<nav class="tab-nav">
    <div class="tab-btn active" onclick="switchTab('dashboard', this)">ğŸ  Ø®Ø§Ù†Ù‡</div>
    <div class="tab-btn" onclick="switchTab('history', this)">ğŸ“œ ØªØ§Ø±ÛŒØ®Ú†Ù‡</div>
    <div class="tab-btn" onclick="switchTab('leaderboard', this)">ğŸ† Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§</div>
</nav>

<script>
    // --- CONFIG ---
    const CONTRACT_ADDRESS = "0xB53223EE5B4C269A87617C8Ac798FcB7e2FDB1FE"; // V6
    const RPC_URL = "https://rpc.minato.soneium.org/";
    const EXPLORER_URL = "https://explorer-testnet.soneium.org/tx/";
    const CHAIN_ID_HEX = '0x79a'; 
    const CHAIN_ID_DEC = 1946;

    const ABI = [
        "function donate(uint256 _projectId, bool _participateInLottery, string memory _sourceApp, uint256 _usdCents) public payable",
        "function getLotteryStatus() public view returns (uint256 pool, uint256 nextDraw, uint256 users)",
        "function getProjectCount() public view returns (uint256)",
        "function getProject(uint256 _id) public view returns (string name, address wallet, uint256 target, uint256 current, bool completed, bool open)",
        "function getGlobalRankings() view returns (tuple(address wallet, uint256 totalAmount)[10])",
        "function checkWinnings(address _user) public view returns (uint256)",
        "function claimWinnings() public",
        "function winnerPercentages(uint256) view returns (uint256)",
        "function getUserAccumulation(address _user) public view returns (uint256 cents, uint256 tickets)",
        "event DonationReceived(address indexed donor, uint256 projectId, uint256 amount, uint256 usdCents, string sourceApp)",
        "event LotteryWinner(address indexed winner, uint256 amount, uint256 rank)"
    ];
    
    let ethPriceUSD = 0; let oneDollarInEth = 0; let isPureCharity = false;
    let provider, signer, contract; let userAddress = null; let currentPot = 0; let currentLbMode = 'global';
    let isProjectsLoading = false;

    window.onload = async () => {
        fetchEthPrice();
        try {
            const readProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
            const readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, readProvider);
            loadGlobalData(readContract);
        } catch(e) { console.log("RPC Error", e); }

        if(window.ethereum) {
            const p = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await p.listAccounts();
            if(accounts.length > 0) connectWallet(true);
        }
    };

    async function connectWallet(silent = false) {
        if(typeof window.ethereum === 'undefined') { if(!silent) alert("Please install MetaMask"); return; }
        const btn = document.getElementById('connectBtn');
        try {
            if(!silent) btn.innerText = "â³...";
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();

            const network = await provider.getNetwork();
            if (network.chainId !== CHAIN_ID_DEC) {
                try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID_HEX }] }); }
                catch (err) {
                    if (err.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{ chainId: CHAIN_ID_HEX, chainName: 'Soneium Minato Testnet', rpcUrls: [RPC_URL], nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }, blockExplorerUrls: ['https://explorer-testnet.soneium.org/'] }]
                        });
                    } else { throw new Error("Switch to Soneium Minato"); }
                }
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
            }

            btn.innerText = userAddress.substring(0,6) + "...";
            document.getElementById('winnerWallet').value = userAddress;
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            loadUserHistory(contract, userAddress);
            loadGlobalData(contract);
            loadUserAccumulation(contract, userAddress);
            checkAndClaim();
        } catch(e) {
            console.error(e);
            if(!silent) { btn.innerText = "Retry"; alert("Connection Failed: " + e.message); }
        }
    }

    async function loadGlobalData(c) { loadContractData(c); loadProjects(c); loadLeaderboard(c); }

    async function loadUserAccumulation(c, address) {
        try {
            const data = await c.getUserAccumulation(address);
            const cents = data.cents.toNumber();
            const tickets = data.tickets.toNumber();
            document.getElementById('userTotalCents').innerText = cents + "Â¢";
            document.getElementById('userTickets').innerText = tickets;
            document.getElementById('userNeed').innerText = (100 - (cents % 100)) + "Â¢";
            document.getElementById('userStatusBox').classList.remove('hidden');
        } catch(e) {}
    }

    async function loadContractData(c) {
        try {
            const status = await c.getLotteryStatus();
            const pot = ethers.utils.formatEther(status.pool);
            currentPot = parseFloat(pot);
            document.getElementById('potDisplay').innerText = parseFloat(pot).toFixed(4) + " ETH";
            document.getElementById('bigPotDisplay').innerText = parseFloat(pot).toFixed(4);
            
            // Fix: Contract timestamp is in seconds, JS needs ms
            const nextDraw = parseInt(status.nextDraw.toString()) * 1000;
            startCountdown(nextDraw);
            
            updateLotteryCalc(c);
        } catch(e) {}
    }

    async function updateLotteryCalc(c) {
        const table = document.getElementById('winnersTable');
        if(ethPriceUSD === 0) { table.innerHTML = "<tr><td colspan='3'>Price loading...</td></tr>"; return; }
        try {
            let html = `<tr><th>Ø±ØªØ¨Ù‡</th><th>Ø³Ù‡Ù…</th><th>Ù…Ø¨Ù„Øº (USD)</th></tr>`;
            for(let i=0; i<5; i++) {
                const percent = await c.winnerPercentages(i); 
                const potUsd = currentPot * ethPriceUSD;
                const winUsd = (potUsd * percent) / 100;
                const rankClass = i === 0 ? 'rank-1' : '';
                html += `<tr><td><span class="rank-badge ${rankClass}">${i+1}</span></td><td>${percent}%</td><td>$${winUsd.toFixed(2)}</td></tr>`;
            }
            table.innerHTML = html;
        } catch(e) { table.innerHTML = "<tr><td colspan='3'>...</td></tr>"; }
    }

    async function loadProjects(c) {
        if (isProjectsLoading) return;
        isProjectsLoading = true;
        try {
            const countBig = await c.getProjectCount();
            const count = countBig.toNumber();
            const sel1 = document.getElementById('projectSelectMain');
            const sel2 = document.getElementById('projectSelectDetails');
            const listCon = document.getElementById('projectListContainer');
            
            let opts = '<option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡...</option>';
            let listHtml = '';
            
            document.getElementById('projectTotal').innerText = count + " Active";
            
            for(let i=0; i<count; i++) {
                const p = await c.getProject(i);
                if(p.open) {
                    const target = ethers.utils.formatEther(p.target);
                    const current = ethers.utils.formatEther(p.current);
                    const txt = `${p.name}`;
                    opts += `<option value="${i}">${txt}</option>`;
                    listHtml += `
                        <div style="background:rgba(0,0,0,0.2); padding:10px; margin-bottom:10px; border-radius:10px;">
                            <div style="font-weight:bold; color:var(--primary)">${p.name}</div>
                            <div style="font-size:12px; margin-top:5px;">Raised: ${parseFloat(current).toFixed(3)} / ${parseFloat(target).toFixed(1)} ETH</div>
                            <div style="height:5px; background:#333; margin-top:5px; border-radius:5px;">
                                <div style="width:${Math.min((current/target)*100, 100)}%; height:100%; background:var(--charity); border-radius:5px;"></div>
                            </div>
                        </div>`;
                }
            }
            sel1.innerHTML = opts; sel2.innerHTML = opts; listCon.innerHTML = listHtml || "<p style='text-align:center'>No active projects.</p>";
            if(count > 0) updateProjectInfo(0);
        } catch(e) { console.log("Project Err", e); }
        finally { isProjectsLoading = false; }
    }

    function switchLbTab(mode, btn) {
        currentLbMode = mode;
        document.querySelectorAll('.lb-tab').forEach(e => e.classList.remove('active'));
        btn.classList.add('active');
        const c = contract || new ethers.Contract(CONTRACT_ADDRESS, ABI, new ethers.providers.JsonRpcProvider(RPC_URL));
        loadLeaderboard(c);
    }

    async function loadLeaderboard(c) {
        const list = document.getElementById('leaderList');
        list.innerHTML = "<p style='text-align:center; padding:20px;'>â³ Loading...</p>";
        try {
            let donors;
            if (currentLbMode === 'global') donors = await c.getGlobalRankings();
            else donors = await c.getGlobalRankings(); // V6 Fallback
            
            const sorted = [...donors].filter(d => d.wallet !== "0x0000000000000000000000000000000000000000").sort((a,b) => parseFloat(b.totalAmount) - parseFloat(a.totalAmount));
            list.innerHTML = "";
            if(sorted.length === 0) { list.innerHTML = "<p style='text-align:center; opacity:0.5; padding:20px'>Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>"; return; }
            
            sorted.forEach((d, idx) => {
                const amount = parseFloat(ethers.utils.formatEther(d.totalAmount)).toFixed(4);
                const rankClass = idx < 3 ? `rank-${idx+1}` : 'rank';
                const color = idx === 0 ? 'var(--lottery)' : '#fff';
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<div style="display:flex; align-items:center;"><div class="rank ${rankClass}">${idx + 1}</div><div class="user-addr">${d.wallet.substring(0,6)}...${d.wallet.substring(38)}</div></div><div style="color:${color}">${amount} ETH</div>`;
                list.appendChild(div);
            });
        } catch(e){ console.log(e); }
    }

   async function loadUserHistory(c, address) {
        if(!address) return;
        const list = document.getElementById('historyList');
        list.innerHTML = "<p style='text-align:center; padding:20px; color:#7aa2f7;'>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ§Ø¨Ù‚...</p>";
        
        try {
            // 1. Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙÛŒÙ„ØªØ± ØµØ­ÛŒØ­
            const filter = c.filters.DonationReceived(address);
            
            // 2. Ø¯Ø±ÛŒØ§ÙØª Ø´Ù…Ø§Ø±Ù‡ Ø¨Ù„Ø§Ú© ÙØ¹Ù„ÛŒ
            const currentBlock = await c.provider.getBlockNumber();
            
            // 3. Ø§Ø³Ú©Ù† ÙÙ‚Ø· Û²Û°Û°Û° Ø¨Ù„Ø§Ú© Ø¢Ø®Ø± (Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ùˆ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ RPC)
            // Ø§Ú¯Ø± Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ø±Ø§ Ø¨ÛŒØ´ØªØ± Ú©Ù†ÛŒØ¯ ÙˆÙ„ÛŒ Ø±ÛŒØ³Ú© Ø®Ø·Ø§ Ø¯Ø§Ø±Ø¯
            const fromBlock = Math.max(0, currentBlock - 2000); 
            
            console.log(`Scanning history for ${address} from block ${fromBlock} to ${currentBlock}...`);
            
            const events = await c.queryFilter(filter, fromBlock, "latest");
            
            if(events.length === 0) {
                list.innerHTML = "<p style='text-align:center; opacity:0.5; padding:20px;'>ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¯Ø± Û²Û°Û°Û° Ø¨Ù„Ø§Ú© Ø§Ø®ÛŒØ± ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>";
                return;
            }
            
            list.innerHTML = "";
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…
            const recentEvents = events.reverse();
            
            for(let ev of recentEvents) {
                try {
                    const args = ev.args;
                    // ØªØ¨Ø¯ÛŒÙ„ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ù‡ Ø§ØªØ±
                    const amount = parseFloat(ethers.utils.formatEther(args.amount)).toFixed(4);
                    const source = args.sourceApp || "Unknown";
                    const hash = ev.transactionHash;
                    
                    // ØªØ¹ÛŒÛŒÙ† Ø¢ÛŒÚ©ÙˆÙ†
                    let icon = source.includes("Runner") ? "ğŸ®" : "ğŸ—ï¸";
                    
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    // Ù‚Ø§Ø¨Ù„ÛŒØª Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¯Ø± Ø§Ú©Ø³Ù¾Ù„ÙˆØ±Ø±
                    div.onclick = () => window.open(EXPLORER_URL + hash, '_blank');
                    
                    div.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="font-size:20px;">${icon}</div>
                            <div>
                                <div style="font-weight:bold; font-size:14px;">${source}</div>
                                <div style="font-size:10px; opacity:0.6; text-decoration:underline; color:#7aa2f7;">
                                    TX: ${hash.substring(0,6)}...
                                </div>
                            </div>
                        </div>
                        <div style="color:var(--primary); font-weight:bold;">${amount} ETH</div>
                    `;
                    list.appendChild(div);
                } catch (innerErr) {
                    console.error("Error parsing event:", innerErr);
                }
            }
        } catch(e) { 
            console.error("History Load Error:", e);
            list.innerHTML = `<p style='text-align:center; color:#f7768e; padding:20px;'>Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø´Ø¨Ú©Ù‡.<br><span style="font-size:10px">RPC Error: Try Refreshing</span></p>`; 
        }
    }

    function prepareDonation() {
        if(!signer) { connectWallet(); return; }
        const val = parseFloat(document.getElementById('amountInput').value);
        const pid = document.getElementById('projectSelectMain').value;
        if(pid === "") return alert("Ù„Ø·ÙØ§Ù‹ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");
        
        const usd = val * ethPriceUSD;
        document.getElementById('modalTotalEth').innerText = val.toFixed(4) + " ETH";
        document.getElementById('modalTotalUsd').innerText = `â‰ˆ $${usd.toFixed(2)}`;
        const con = document.getElementById('breakdownContainer');
        con.innerHTML = isPureCharity ? 
            `<div class="breakdown-row"><span style="color:var(--charity)">Ù¾Ø±ÙˆÚ˜Ù‡ (Û±Û°Û°Ùª)</span><span>$${usd.toFixed(2)}</span></div>` :
            `<div class="breakdown-row"><span style="color:var(--charity)">Ø®ÛŒØ±ÛŒÙ‡ (Û¶Û°Ùª)</span><span>$${(usd*0.6).toFixed(2)}</span></div><div class="breakdown-row"><span style="color:var(--lottery)">Ù„Ø§ØªØ§Ø±ÛŒ (Û³Û°Ùª)</span><span>$${(usd*0.3).toFixed(2)}</span></div><div class="breakdown-row"><span style="color:var(--treasury)">ØªÛŒÙ… (Û±Û°Ùª)</span><span>$${(usd*0.1).toFixed(2)}</span></div>`;
        document.getElementById('confirmModal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('confirmModal').classList.add('hidden'); }
    
    async function executeTransaction() {
        closeModal();
        const val = document.getElementById('amountInput').value;
        const pid = document.getElementById('projectSelectMain').value;
        const wei = ethers.utils.parseEther(val);
        
        const usdVal = parseFloat(val) * ethPriceUSD;
        const usdCents = Math.floor(usdVal * 100);

        try {
            document.getElementById('payBtn').innerText = "â³ ..."; document.getElementById('payBtn').disabled = true;
            
            // Re-init contract with signer for write op
            const writeContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

            const tx = await writeContract.donate(pid, !isPureCharity, "CharityPortal", usdCents, { value: wei });
            await tx.wait();
            
            document.getElementById('successBox').style.display = "block";
            document.getElementById('txLink').href = EXPLORER_URL + tx.hash;
            setTimeout(() => { 
                loadUserHistory(writeContract, userAddress); 
                loadGlobalData(writeContract); 
                loadUserAccumulation(writeContract, userAddress); 
            }, 3000);
            document.getElementById('payBtn').innerText = "PAY & DONATE"; document.getElementById('payBtn').disabled = false;
        } catch(e) { alert("Error: " + e.message); document.getElementById('payBtn').innerText = "PAY & DONATE"; document.getElementById('payBtn').disabled = false; }
    }

    async function checkAndClaim() {
        if(!signer) { await connectWallet(); return; }
        try {
            const pending = await contract.checkWinnings(userAddress);
            if(pending > 0) {
                if(confirm(`Claim ${ethers.utils.formatEther(pending)} ETH?`)) {
                    const tx = await contract.claimWinnings(); await tx.wait(); alert("âœ… Paid!");
                }
            } else { alert("No pending winnings."); }
        } catch(e){ alert("Error checking"); }
    }

    async function fetchEthPrice() { try { const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd'); const d=await r.json(); ethPriceUSD=d.ethereum.usd; oneDollarInEth=1/ethPriceUSD; document.getElementById('ethPriceDisplay').innerText=`ETH: $${ethPriceUSD}`; const def=(oneDollarInEth*5).toFixed(4); document.getElementById('amountInput').value=def; updateCalculations(def); } catch(e){ ethPriceUSD=3000; updateCalculations(0.001); } }
    
    function updateCalculations(val) { 
        const v = parseFloat(val); if(isNaN(v)) return; 
        const usd = v * ethPriceUSD; 
        document.getElementById('usdDisplay').innerText = `â‰ˆ $${usd.toFixed(2)} USD`; 
        const tickets = Math.floor(usd); 
        const payBtn = document.getElementById('payBtn'); 
        const warning = document.getElementById('minWarning'); 
        const ticketBadge = document.getElementById('ticketCount'); 
        
        if (isPureCharity) { 
            ticketBadge.innerText = "â¤ï¸ 100%"; ticketBadge.style.background = "#9ece6a"; 
            warning.style.display = 'none'; 
        } else { 
            ticketBadge.innerText = `ğŸŸï¸ ${tickets}`; ticketBadge.style.background = "#e0af68"; 
            if (usd < 0.95) { 
                warning.style.display = 'block'; warning.innerHTML = "âš ï¸ Ù…Ø¨Ù„Øº < $1: Ø§Ù†Ø¨Ø§Ø´Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Accumulate)"; 
            } else { 
                warning.style.display = 'none'; 
            } 
        }
        // Always enabled in V6 (Accumulation)
        payBtn.disabled = false; payBtn.innerText = "PAY & DONATE"; payBtn.style.opacity = 1; 
    }
    
    function syncSlider(v) { document.getElementById('amountSlider').value=v; updateCalculations(v); }
    function syncInput(v) { document.getElementById('amountInput').value=v; updateCalculations(v); }
    function togglePureCharity(c) { isPureCharity=c; const b=document.getElementById('distBar'); if(c) b.innerHTML=`<div class="bar-part" style="width:100%;background:var(--charity)">100% CHARITY DIRECT</div>`; else b.innerHTML=`<div class="bar-part" style="width:60%;background:var(--charity)">60%</div><div class="bar-part" style="width:30%;background:var(--lottery)">30%</div><div class="bar-part" style="width:10%;background:var(--treasury)">10%</div>`; updateCalculations(document.getElementById('amountInput').value); }
    
    function startCountdown(t) { 
        setInterval(()=>{ 
            const d=t-Date.now(); 
            if(d<=0) { document.getElementById('timer').innerText="DRAW!"; if(document.getElementById('timerBig')) document.getElementById('timerBig').innerText="DRAW!"; return; } 
            const dd=Math.floor(d/86400000); const h=Math.floor((d%86400000)/3600000); const m=Math.floor((d%3600000)/60000); 
            const txt=`${dd}d ${h}h ${m}m`; 
            document.getElementById('timer').innerText=txt; if(document.getElementById('timerBig')) document.getElementById('timerBig').innerText=txt; 
        }, 1000); 
    }
    
    function switchTab(p,b) { document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); if(p==='dashboard')showPage('dashboard'); else if(p==='history')showPage('history'); else if(p==='leaderboard')showPage('leaderboard'); }
    function showPage(p) { document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); const c = contract || new ethers.Contract(CONTRACT_ADDRESS, ABI, new ethers.providers.JsonRpcProvider(RPC_URL)); if(p==='lottery') updateLotteryCalc(c); if(p==='projects') loadProjects(c); }
    function switchLbTab(mode, btn) { currentLbMode=mode; document.querySelectorAll('.lb-tab').forEach(e=>e.classList.remove('active')); btn.classList.add('active'); const c = contract || new ethers.Contract(CONTRACT_ADDRESS, ABI, new ethers.providers.JsonRpcProvider(RPC_URL)); loadLeaderboard(c); }
    
    const projectDetailsData = { 0: { name: "Ù…Ø¯Ø±Ø³Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³ÛŒØ³ØªØ§Ù†", desc: "ØªØ¬Ù‡ÛŒØ² Û±Û° Ú©Ù„Ø§Ø³ Ø¯Ø±Ø³.", tg: "#", yt: "#", in: "#" }, 1: { name: "Ø¯Ø±Ù…Ø§Ù†Ú¯Ø§Ù‡ Ø§Ù…ÛŒØ¯", desc: "ØªØ§Ù…ÛŒÙ† Ø¯Ø§Ø±Ùˆ.", tg: "#", yt: "#", in: "#" }, 2: { name: "Ø¢Ø¨â€ŒØ±Ø³Ø§Ù†ÛŒ Ø±ÙˆØ³ØªØ§", desc: "Ù¾Ø±ÙˆÚ˜Ù‡ Ù„ÙˆÙ„Ù‡â€ŒÚ©Ø´ÛŒ.", tg: "#", yt: "#", in: "#" } };
    function updateProjectInfo(id) { const info = projectDetailsData[id] || { name: "Project #"+id, desc: "No info.", tg:"#" }; document.getElementById('pName').innerText = info.name; document.getElementById('pDesc').innerText = info.desc; document.getElementById('lnkTele').href = info.tg; }
</script>
</body>
</html>