<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homa - Final Boss Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        body { margin: 0; padding: 0; background-color: #202020; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'VT323', 'Arial', sans-serif; overflow: hidden; color: white; user-select: none; }
        #gameContainer { position: relative; width: 100%; max-width: 400px; height: 600px; background-image: url('Background.png'); background-size: cover; background-position: center; overflow: hidden; border: 4px solid #333; border-radius: 10px; box-shadow: 0 0 30px rgba(0,0,0,0.7); image-rendering: pixelated; transition: filter 1s ease; }
        
        /* UI */
        #projectStatus { position: absolute; top: 0; left: 0; width: 100%; background: rgba(108, 92, 231, 0.95); color: #fff; padding: 5px 0; text-align: center; font-size: 14px; z-index: 15; border-bottom: 3px solid #fab1a0; }
        #lotteryPot { position: absolute; top: 40px; right: 10px; color: #ffd700; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 0 #000; z-index: 10; }
        #scoreBoard { position: absolute; top: 40px; left: 20px; font-size: 24px; font-weight: bold; color: #fff; z-index: 10; text-shadow: 2px 2px 0 #6c5ce7; }
        #levelDisplay { position: absolute; top: 70px; left: 20px; font-size: 18px; color: #fab1a0; font-weight: bold; text-shadow: 1px 1px 0 #000; z-index: 10; }
        
        #powerupStatus { position: absolute; top: 100px; left: 20px; display: flex; flex-direction: column; gap: 5px; z-index: 10; }
        .status-item { font-size: 18px; font-weight: bold; text-shadow: 0 0 5px #000; opacity: 0; transition: opacity 0.3s; }
        .shield-active { color: #00cec9; opacity: 1; }
        .fire-active { color: #ff7675; opacity: 1; animation: pulse-text 1s infinite; }
        .star-active { color: #ffeaa7; opacity: 1; animation: rainbow-text 0.5s infinite; }
        @keyframes rainbow-text { 0% { color: #ff0000; } 50% { color: #00ffff; } 100% { color: #ff00ff; } }
        @keyframes pulse-text { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Boss Warning */
        #bossWarning { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; color: #e74c3c; font-weight: bold; text-shadow: 4px 4px 0 #000; z-index: 50; display: none; animation: blink 0.2s infinite; text-align: center; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; border: 2px solid red; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
        
        .boss-health-bar { position: absolute; width: 100%; height: 10px; background: #333; border: 2px solid #fff; top: -20px; left: 0; display: block; z-index: 7; }
        .boss-health-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.1s; }

        .combo-text { position: absolute; font-size: 30px; font-weight: bold; background: linear-gradient(45deg, #ff00cc, #3333ff); -webkit-background-clip: text; color: transparent; text-shadow: 2px 2px 0 #fff; pointer-events: none; z-index: 25; animation: zoomUp 0.6s ease-out forwards; }
        @keyframes zoomUp { 0% { transform: scale(0.5) translateY(0); opacity: 0; } 50% { transform: scale(1.5) translateY(-20px); opacity: 1; } 100% { transform: scale(1) translateY(-60px); opacity: 0; } }

        #shootBtn { position: absolute; bottom: 20px; right: 20px; width: 80px; height: 80px; background: radial-gradient(circle, #e74c3c, #c0392b); border: 4px solid #fff; border-radius: 50%; color: white; font-size: 40px; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 15px #e74c3c; cursor: pointer; z-index: 50; display: none; transition: transform 0.1s; }
        #shootBtn:active { transform: scale(0.9); }

        #dailyQuestBox { width: 85%; background: rgba(0,0,0,0.6); border: 2px solid #fab1a0; border-radius: 10px; padding: 10px; margin-top: 10px; text-align: left; font-size: 14px; color: #fff; }
        .quest-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .quest-done { color: #2ecc71; text-decoration: line-through; }

        /* Objects */
        #player { position: absolute; width: 50px; height: 50px; bottom: 80px; left: 50px; z-index: 5; background-image: url('Teddy_Bear.png'); background-repeat: no-repeat; background-size: contain; animation: run-bob 0.2s infinite alternate; transition: transform 0.1s; }
        .shielded { filter: drop-shadow(0 0 5px #00cec9) drop-shadow(0 0 15px #0984e3); }
        .fiery { filter: drop-shadow(0 0 5px #e74c3c) sepia(1) saturate(5); }
        .invincible { animation: rainbow-filter 0.5s infinite !important; }
        @keyframes rainbow-filter { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .jump-anim { animation: jump-rotate 0.5s ease-out !important; }
        .fall-anim { transform: rotate(180deg) scale(0.5) !important; filter: sepia(1) hue-rotate(-50deg) saturate(5); transition: all 0.5s; }
        @keyframes run-bob { from { transform: translateY(0); } to { transform: translateY(-3px); } }
        @keyframes jump-rotate { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } 100% { transform: translateY(0) rotate(0deg); } }

        .obstacle { position: absolute; width: 40px; height: 60px; z-index: 4; background-repeat: no-repeat; background-size: contain; }
        .enemy { position: absolute; width: 40px; height: 40px; z-index: 4; background-repeat: no-repeat; background-size: contain; animation: waddle 0.5s infinite alternate; }
        @keyframes waddle { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }
        
        /* BOSS */
        .boss { 
            position: absolute; width: 140px; height: 140px; z-index: 6; 
            background-repeat: no-repeat; background-size: contain; 
            background-color: rgba(255, 0, 0, 0.0); /* Transparent */
            /* Important: No CSS transitions! */
            transition: none !important;
        }
        .boss-hit { filter: brightness(100) !important; background-color: rgba(255,255,255,0.5) !important; }
        
        .cage { position: absolute; width: 50px; height: 50px; z-index: 4; background-repeat: no-repeat; background-size: contain; }
        .mystery-box { position: absolute; width: 40px; height: 40px; z-index: 4; background-repeat: no-repeat; background-size: contain; animation: box-glow 1s infinite alternate; }
        @keyframes box-glow { from { transform: scale(1); } to { transform: scale(1.05); } }
        .box-empty { filter: grayscale(100%) brightness(0.5); transform: scale(0.95); }
        .box-hit { animation: box-bump 0.2s ease-out; }
        @keyframes box-bump { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
        .fireball { position: absolute; width: 25px; height: 25px; background: #ff9f43; border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 15px #e67e22; z-index: 6; animation: spin 0.3s infinite linear; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .pit { position: absolute; width: 80px; height: 90px; bottom: 0; z-index: 2; background: linear-gradient(to top, #cf1020, #ff4500); border-left: 5px solid #2d3436; border-right: 5px solid #2d3436; overflow: hidden; box-shadow: inset 0 0 20px #500; }
        .pit::after { content: ''; position: absolute; width: 100%; height: 100%; background-image: radial-gradient(circle, rgba(255,255,0,0.4) 10%, transparent 20%); background-size: 20px 20px; animation: lava-bubble 1s infinite linear; }
        @keyframes lava-bubble { from { background-position: 0 0; } to { background-position: 0 -20px; } }
        .collectible { position: absolute; width: 32px; height: 32px; z-index: 4; background-repeat: no-repeat; background-size: contain; animation: float 0.8s infinite alternate; filter: drop-shadow(0 0 5px gold); }
        @keyframes float { from { transform: translateY(0); } to { transform: translateY(-8px); } }
        #ground { position: absolute; bottom: 0; width: 100%; height: 100px; z-index: 3; background-image: url('Foreground.png'); background-repeat: repeat-x; background-size: auto 100%; }
        
        /* Screens */
        #startScreen, #gameOverScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 52, 54, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; text-align: center; backdrop-filter: blur(5px); }
        .panel { background: #dfe6e9; color: #2d3436; padding: 20px; border: 4px solid #6c5ce7; width: 85%; max-width: 320px; border-radius: 15px; box-shadow: 8px 8px 0 rgba(0,0,0,0.3); animation: popIn 0.3s ease-out; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        h1 { margin: 0 0 10px 0; color: #fab1a0; text-shadow: 3px 3px 0 #6c5ce7; font-size: 40px; }
        button.action-btn { background: #6c5ce7; border: 3px solid #fff; padding: 10px 20px; color: white; font-size: 22px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; font-family: 'VT323', sans-serif; border-radius: 10px; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); transition: all 0.05s; }
        button.action-btn:active { transform: translate(4px, 4px); box-shadow: 0 0 0 #000; }
        button.secondary-btn { background: #b2bec3; color: #2d3436; border-color: #636e72; font-size: 18px; margin-top: 5px; }
        button.danger-btn { background: #d63031; border-color: #c0392b; font-size: 18px; }
        button.connect-green { background: #2ecc71; border-color: #27ae60; }
        #connectBtn { background: #8e44ad; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .share-btn { background: transparent; border: 2px solid #0984e3; color: #0984e3; margin-top: 8px; font-size: 18px; padding: 5px; cursor: pointer; font-family: 'VT323'; width: 100%; border-radius: 8px; }
        .hidden { display: none !important; }
        
        .shake-effect { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .frenzy-mode { animation: disco-bg 0.5s infinite alternate !important; }
        @keyframes disco-bg { 0% { filter: hue-rotate(0deg) contrast(1.2); } 100% { filter: hue-rotate(360deg) contrast(1.2); } }
        .dust { position: absolute; width: 10px; height: 10px; background: rgba(255,255,255,0.6); border-radius: 50%; pointer-events: none; z-index: 3; animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { to { transform: scale(2); opacity: 0; } }
        .float-text { position: absolute; font-size: 24px; font-weight: bold; color: #ffd700; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 20; animation: floatUp 0.8s ease-out forwards; }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
        .donation-control { margin: 10px 0; text-align: center; }
        input[type=range] { width: 100%; margin: 5px 0; accent-color: #6c5ce7; }
        #levelUpMsg { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; color: #fab1a0; font-weight: bold; text-shadow: 4px 4px 0 #6c5ce7; pointer-events: none; opacity: 0; z-index: 50; }
        .show-levelup { animation: floatUp 2s ease-out forwards; }
        #schoolCanvas { margin: 10px auto; border: 4px solid #fff; border-radius: 5px; background: #81ecec; display: block; }
        
        /* Settings */
        #settingsBtn { position: absolute; top: 10px; left: 10px; font-size: 24px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 100; transition: transform 0.2s; }
        #settingsBtn:hover { transform: rotate(90deg); }
        #settingsModal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 101; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .settings-panel { background: #2d3436; border: 4px solid #0984e3; padding: 20px; width: 80%; border-radius: 10px; text-align: center; }
        .setting-row { margin: 15px 0; display: flex; justify-content: space-between; align-items: center; font-size: 20px; }
        .wallet-addr { font-size: 14px; color: #fab1a0; word-break: break-all; }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="settingsBtn" onclick="toggleSettings()">‚öôÔ∏è</div>
    <div id="settingsModal" class="hidden">
        <div class="settings-panel">
            <h2 style="color:#fff">SETTINGS</h2>
            <div class="setting-row"><span>Wallet:</span><span id="walletDisplay" class="wallet-addr">Guest</span></div>
            <div class="setting-row"><span>Sound:</span><button id="soundToggle" class="action-btn" style="margin:0; padding:5px 10px; width:auto;" onclick="toggleMute()">ON</button></div>
            <div class="setting-row"><span>Vibrate:</span><button id="vibrateToggle" class="action-btn" style="margin:0; padding:5px 10px; width:auto;" onclick="toggleVibrate()">ON</button></div>
            <button id="walletActionBtn" class="action-btn connect-green" onclick="handleWalletAction()">üîå CONNECT</button>
            <button class="action-btn secondary-btn" style="margin-top:20px;" onclick="toggleSettings()">CLOSE</button>
        </div>
    </div>

    <div id="projectStatus">üèóÔ∏è School Project: <b>Phase 1</b> | Funds: <span id="raisedFundsDisplay" style="color:#55efc4">...</span></div>
    <div id="lotteryPot">üèÜ POT: ??? ETH</div>
    <div id="levelUpMsg">LEVEL UP!</div>
    <div id="bossWarning">‚ö†Ô∏è BOSS BATTLE ‚ö†Ô∏è<br><span style="font-size:20px; color:white">SHOOT TO KILL!</span></div>
    
    <div id="scoreBoard">üíé 0</div>
    <div id="levelDisplay">LVL 1</div>
    <div id="powerupStatus">
        <div id="shieldText" class="status-item">üõ°Ô∏è SHIELD</div>
        <div id="fireText" class="status-item">üî• FIRE LOADED!</div>
        <div id="starText" class="status-item">‚≠ê FRENZY!</div>
    </div>
    
    <div id="shootBtn" onclick="shootFireball(event)">üî•</div>

    <div id="startScreen">
        <h1>HOMA RUNNER</h1>
        <canvas id="schoolCanvas" width="200" height="120"></canvas>
        
        <div id="dailyQuestBox">
            <div style="text-align:center; margin-bottom:5px; color:#fab1a0;">üìÖ DAILY QUESTS</div>
            <div id="quest1" class="quest-item">üß± Collect 50 Bricks <span>0/50</span></div>
            <div id="quest2" class="quest-item">üëπ Defeat 1 Boss <span>0/1</span></div>
        </div>

        <div style="display:flex; flex-direction:column; gap:10px; width:80%; margin-top:10px;">
            <button id="connectBtn" class="action-btn" onclick="connectWallet()">üîå CONNECT WALLET</button>
            <button id="playFunBtn" class="action-btn secondary-btn" onclick="playForFun()">üéÆ PLAY FOR FUN</button>
            <button id="startBtn" class="action-btn hidden" onclick="startGame(event)">‚ñ∂ START GAME</button>
        </div>
        <p style="font-size: 14px; margin-top:10px; color:#fab1a0;" id="savedLevelInfo">Join to save progress</p>
    </div>

    <div id="gameOverScreen" class="hidden">
        <div class="panel">
            <h2 style="color:#d63031">GAME OVER</h2>
            <div style="font-size: 20px;">Score: <b id="finalScore">0</b></div>
            <hr style="border: 1px solid #6c5ce7; margin: 10px 0;">
            <div style="font-size: 14px; color: #2d3436; margin-bottom:5px;">üéüÔ∏è Buy Lottery Ticket</div>
            <div class="donation-control">
                <label>Multiplier: <span id="multiplierValue" style="font-weight:bold; color:#d63031">1x</span></label>
                <input type="range" id="multiplierSlider" min="1" max="100" value="1" oninput="updateDonationCalc()">
                <div style="font-size: 16px; color:#00b894; font-weight:bold; margin-top:5px;" id="ethCost">0.00001 ETH</div>
            </div>
            <button id="payBtn" class="action-btn" style="background: #00b894;" onclick="processDonation()">DONATE & RANK</button>
            <button class="share-btn" onclick="shareScore()">üì¢ SHARE</button>
            <button onclick="backToMenu()" style="background:none; border:none; margin-top:10px; cursor:pointer; text-decoration:underline;">MAIN MENU</button>
        </div>
    </div>

    <div id="player"></div>
    <div id="ground"></div>
</div>

<script type="module">
    import sdk from 'https://esm.sh/@farcaster/frame-sdk';
    try { sdk.actions.ready(); } catch(e) { console.log("SDK Error:", e); }
</script>

<script>
    // --- Generators ---
    function createBoxTexture() { const c=document.createElement('canvas');c.width=40;c.height=40;const x=c.getContext('2d');x.fillStyle='#f1c40f';x.fillRect(0,0,40,40);x.fillStyle='#d35400';x.fillRect(2,2,36,36);x.fillStyle='#f39c12';x.fillRect(5,5,30,30);x.fillStyle='#fff';x.font='bold 30px monospace';x.fillText('?',12,30);x.fillStyle='#000';x.fillRect(2,2,2,2);x.fillRect(36,2,2,2);return c.toDataURL(); }
    const boxTexture = createBoxTexture();
    function createEnemyTexture() { const c=document.createElement('canvas');c.width=40;c.height=40;const x=c.getContext('2d');x.fillStyle='#c0392b';x.beginPath();x.arc(20,20,18,Math.PI,0);x.fill();x.fillStyle='#ecf0f1';x.beginPath();x.arc(12,12,4,0,Math.PI*2);x.fill();x.beginPath();x.arc(28,15,3,0,Math.PI*2);x.fill();x.fillStyle='#f1c40f';x.fillRect(12,20,16,18);x.fillStyle='#000';x.fillRect(16,24,2,4);x.fillRect(22,24,2,4);return c.toDataURL(); }
    const enemyTexture = createEnemyTexture();
    function createBossRed() { const c=document.createElement('canvas');c.width=140;c.height=140;const x=c.getContext('2d');x.fillStyle='#c0392b';x.beginPath();x.arc(70,70,60,0,Math.PI*2);x.fill();x.fillStyle='#000';x.beginPath();x.moveTo(50,60);x.lineTo(60,70);x.stroke();x.beginPath();x.moveTo(90,60);x.lineTo(80,70);x.stroke();x.fillStyle='#fff';x.fillRect(50,80,40,10);return c.toDataURL(); }
    function createBossFlying() { const c=document.createElement('canvas');c.width=140;c.height=140;const x=c.getContext('2d');x.fillStyle='#3498db';x.beginPath();x.arc(70,70,50,0,Math.PI*2);x.fill();x.fillStyle='#ecf0f1';x.beginPath();x.moveTo(20,60);x.lineTo(120,60);x.lineTo(70,100);x.fill(); x.fillStyle='#000';x.fillRect(60,60,5,5);x.fillRect(75,60,5,5);return c.toDataURL(); }
    function createBossStone() { const c=document.createElement('canvas');c.width=140;c.height=140;const x=c.getContext('2d');x.fillStyle='#7f8c8d';x.fillRect(20,20,100,100);x.fillStyle='#2c3e50';x.fillRect(30,40,20,20);x.fillRect(90,40,20,20);x.fillRect(50,90,40,10);return c.toDataURL(); }
    const bossTextures = { red: createBossRed(), flying: createBossFlying(), stone: createBossStone() };
    function createCageTexture() { const c=document.createElement('canvas');c.width=50;c.height=50;const x=c.getContext('2d');x.fillStyle='#bdc3c7';x.fillRect(0,0,50,50);x.fillStyle='#8B4513';x.beginPath();x.arc(25,30,10,0,Math.PI*2);x.fill(); x.fillStyle='#333';x.fillRect(5,0,5,50);x.fillRect(20,0,5,50);x.fillRect(35,0,5,50); return c.toDataURL(); }
    const cageTexture = createCageTexture();
    function drawSchool(ethAmount) { const cvs=document.getElementById('schoolCanvas');const ctx=cvs.getContext('2d');ctx.clearRect(0,0,200,120);const stage=ethAmount<0.001?0:(ethAmount<0.01?1:(ethAmount<0.1?2:3));ctx.fillStyle='#2ecc71';ctx.fillRect(0,100,200,20);if(stage>=0){ctx.fillStyle='#8B4513';ctx.fillRect(150,70,5,30);ctx.fillStyle='#fff';ctx.fillRect(130,50,45,20);ctx.fillStyle='#000';ctx.font='10px Arial';ctx.fillText('SITE',140,65);}if(stage>=1){ctx.fillStyle='#95a5a6';ctx.fillRect(50,90,100,10);ctx.fillStyle='#7f8c8d';ctx.fillRect(50,90,10,10);ctx.fillRect(140,90,10,10);}if(stage>=2){ctx.fillStyle='#e74c3c';ctx.fillRect(55,50,90,40);ctx.fillStyle='#c0392b';ctx.beginPath();ctx.moveTo(50,50);ctx.lineTo(100,20);ctx.lineTo(150,50);ctx.fill();}if(stage>=3){ctx.fillStyle='#3498db';ctx.fillRect(65,60,20,20);ctx.fillRect(115,60,20,20);ctx.fillStyle='#f1c40f';ctx.fillRect(90,70,20,20);ctx.fillStyle='#2c3e50';ctx.beginPath();ctx.moveTo(100,20);ctx.lineTo(100,5);ctx.stroke();ctx.fillStyle='#e67e22';ctx.fillRect(100,5,15,10);} }

    const obstacleImages = ['Obstacle_1.png', 'Obstacle_2.png', 'Obstacle_3.png'];
    const CONTRACT_ADDRESS = "0x0B0D08BCd6fE53e91330d3F80A6C039Bb489058e"; 
    const BASE_PRICE = 0.00001; 
    const SONEIUM_CHAIN_ID = '0x79A';
    const CONTRACT_ABI = ["function submitScoreAndDonate(uint256 _level) public payable", "function getLotteryStatus() public view returns (uint256, uint256)"];

    // UI
    const player=document.getElementById('player'), gameContainer=document.getElementById('gameContainer'), scoreBoard=document.getElementById('scoreBoard'), levelDisplay=document.getElementById('levelDisplay'), levelUpMsg=document.getElementById('levelUpMsg'), bossWarning=document.getElementById('bossWarning');
    const startScreen=document.getElementById('startScreen'), gameOverScreen=document.getElementById('gameOverScreen'), savedLevelInfo=document.getElementById('savedLevelInfo'), lotteryPotDisplay=document.getElementById('lotteryPot');
    const payBtn=document.getElementById('payBtn'), connectBtn=document.getElementById('connectBtn'), startBtn=document.getElementById('startBtn'), playFunBtn=document.getElementById('playFunBtn');
    const shieldText=document.getElementById('shieldText'), fireText=document.getElementById('fireText'), starText=document.getElementById('starText'), shootBtn=document.getElementById('shootBtn');
    const settingsModal=document.getElementById('settingsModal'), walletDisplay=document.getElementById('walletDisplay'), soundToggle=document.getElementById('soundToggle'), vibrateToggle=document.getElementById('vibrateToggle'), walletActionBtn=document.getElementById('walletActionBtn');
    const quest1UI = document.getElementById('quest1'), quest2UI = document.getElementById('quest2');

    let isGameRunning=false, bricks=0, currentLevel=1, savedLevel=1;
    let playerBottom=80, jumpSpeed=0, obstacles=[], pits=[], collectibles=[], mysteryBoxes=[], enemies=[], bullets=[], cages=[], gameLoopId, spawnerId;
    let gameSpeed=6, hasShield=false, hasFire=false, hasStar=false, isFrenzy=false, jumpCount=0, starTimer, fireTimer, starsCollected=0;
    let isMuted=false, isVibrate=true, isGuest=true, userAddress=null;
    let isConnecting = false;

    let bossMode = false, boss = null, bossEncountered = false;
    let comboCount = 0, comboTimer;
    let dailyQuests = { bricks: 0, bossKills: 0, targetBricks: 50, targetBoss: 1, done1: false, done2: false };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if(isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
        osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if(type==='jump'){ osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(300, now+0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now+0.1); osc.start(now); osc.stop(now+0.1); if(isVibrate && navigator.vibrate) navigator.vibrate(10); }
        if(type==='collect'){ osc.type='sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.setValueAtTime(800, now+0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now+0.2); osc.start(now); osc.stop(now+0.2); if(isVibrate && navigator.vibrate) navigator.vibrate(20); }
        if(type==='die'){ osc.type='sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now+0.4); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now+0.4); osc.start(now); osc.stop(now+0.4); if(isVibrate && navigator.vibrate) navigator.vibrate([100,50,100]); }
        if(type==='levelup'){ osc.type='triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(600, now+0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now+0.4); osc.start(now); osc.stop(now+0.4); if(isVibrate && navigator.vibrate) navigator.vibrate([50,50,50]); }
        if(type==='powerup'){ osc.type='square'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now+0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); if(isVibrate && navigator.vibrate) navigator.vibrate(50); }
        if(type==='break'){ osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0, now+0.1); osc.start(now); osc.stop(now+0.1); if(isVibrate && navigator.vibrate) navigator.vibrate(50); }
        if(type==='stomp'){ osc.type='square'; osc.frequency.setValueAtTime(200, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now+0.1); if(navigator.vibrate) navigator.vibrate(30); }
        if(type==='bump'){ osc.type='triangle'; osc.frequency.setValueAtTime(100, now); gainNode.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now+0.1); if(navigator.vibrate) navigator.vibrate(20); }
        if(type==='shoot'){ osc.type='square'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(200, now+0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now+0.1); osc.start(now); osc.stop(now+0.1); if(isVibrate && navigator.vibrate) navigator.vibrate(10); }
        if(type==='boss_die'){ osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(500, now+0.5); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0, now+0.5); osc.start(now); osc.stop(now+0.5); if(isVibrate && navigator.vibrate) navigator.vibrate(500); }
        if(type==='rescue'){ osc.type='sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.linearRampToValueAtTime(800, now+0.2); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now+0.3); osc.start(now); osc.stop(now+0.3); if(isVibrate && navigator.vibrate) navigator.vibrate(50); }
    }

    function shareScore() { const text = `I scored ${bricks} points in Homa! üêªüß± Helping build a school on Soneium.\n\nCan you beat me? #SoneiumSpark`; const url = "https://homa-xi.vercel.app"; const shareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(text)}&embeds[]=${encodeURIComponent(url)}`; window.open(shareUrl, '_blank'); }
    function toggleSettings() { settingsModal.classList.toggle('hidden'); }
    function toggleMute() { isMuted = !isMuted; soundToggle.innerText = isMuted ? "OFF" : "ON"; soundToggle.style.background = isMuted ? "#d63031" : "#2ecc71"; }
    function toggleVibrate() { isVibrate = !isVibrate; vibrateToggle.innerText = isVibrate ? "ON" : "OFF"; vibrateToggle.style.background = isVibrate ? "#2ecc71" : "#d63031"; }
    function handleWalletAction() { if(isGuest) { connectWallet().then(() => { if(!isGuest) { walletActionBtn.innerText = "‚ùå DISCONNECT"; walletActionBtn.className = "action-btn danger-btn"; } }); } else { disconnectWallet(); } }
    function disconnectWallet() { userAddress = null; isGuest = true; savedLevel = 1; walletDisplay.innerText = "Guest Mode"; walletActionBtn.innerText = "üîå CONNECT WALLET"; walletActionBtn.className = "action-btn connect-green"; connectBtn.classList.remove('hidden'); startBtn.classList.add('hidden'); playFunBtn.classList.remove('hidden'); savedLevelInfo.innerText = "Disconnected"; alert("Wallet Disconnected"); toggleSettings(); }
    function loadQuests() { const saved = localStorage.getItem('homaQuests'); if(saved) dailyQuests = JSON.parse(saved); updateQuestUI(); }
    function updateQuest(type, amount) { if(type === 'brick') dailyQuests.bricks += amount; if(type === 'boss') dailyQuests.bossKills += amount; if(dailyQuests.bricks >= dailyQuests.targetBricks && !dailyQuests.done1) { dailyQuests.done1 = true; activateShield(); spawnFloatingText(200, 300, "QUEST DONE!", 'normal'); } if(dailyQuests.bossKills >= dailyQuests.targetBoss && !dailyQuests.done2) { dailyQuests.done2 = true; activateStar(); spawnFloatingText(200, 300, "QUEST DONE!", 'normal'); } localStorage.setItem('homaQuests', JSON.stringify(dailyQuests)); updateQuestUI(); }
    function updateQuestUI() { quest1UI.innerHTML = `üß± Collect 50 Bricks <span>${dailyQuests.bricks}/${dailyQuests.targetBricks}</span>`; if(dailyQuests.done1) quest1UI.classList.add('quest-done'); quest2UI.innerHTML = `üëπ Defeat 1 Boss <span>${dailyQuests.bossKills}/${dailyQuests.targetBoss}</span>`; if(dailyQuests.done2) quest2UI.classList.add('quest-done'); }
    function addCombo() { comboCount++; clearTimeout(comboTimer); comboTimer = setTimeout(() => { comboCount = 0; }, 1500); if (comboCount > 1) { spawnFloatingText(150, 300, `COMBO x${comboCount}!`, 'combo'); return comboCount; } return 1; }
    function shakeScreen() { gameContainer.classList.add('shake-effect'); setTimeout(() => gameContainer.classList.remove('shake-effect'), 400); }
    function spawnDust(x, y) { const d1=document.createElement('div');d1.className='dust';d1.style.left=(x-10)+'px';d1.style.bottom=y+'px';const d2=document.createElement('div');d2.className='dust';d2.style.left=(x+40)+'px';d2.style.bottom=y+'px';gameContainer.appendChild(d1);gameContainer.appendChild(d2);setTimeout(()=>{d1.remove();d2.remove()},500); }
    function spawnFloatingText(x, y, text, type) { const el=document.createElement('div'); if(type === 'combo') el.className='combo-text'; else el.className='float-text'; el.innerText=text; el.style.left=x+'px'; el.style.bottom=(y+40)+'px'; gameContainer.appendChild(el); setTimeout(()=>el.remove(),800); }

    async function switchToSoneium() { if (typeof window.ethereum === 'undefined') return; try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SONEIUM_CHAIN_ID }], }); } catch (e) { if (e.code === 4902) { try { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: SONEIUM_CHAIN_ID, chainName: 'Soneium Minato Testnet', rpcUrls: ['https://rpc.minato.soneium.org/'], nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }, blockExplorerUrls: ['https://explorer-testnet.soneium.org/'] }], }); } catch (ee) {} } } }
    async function connectWallet() {
        if (isConnecting) return; isConnecting = true;
        if (typeof window.ethereum === 'undefined') { alert("Please install MetaMask"); isConnecting = false; return; }
        try {
            connectBtn.innerText = "‚è≥ ...";
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            userAddress = accounts[0];
            await switchToSoneium();
            const signer = provider.getSigner(); const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            const status = await contract.getLotteryStatus();
            const poolEth = ethers.utils.formatEther(status[0]);
            lotteryPotDisplay.innerText = `üèÜ POT: ${parseFloat(poolEth).toFixed(5)} ETH`;
            drawSchool(parseFloat(poolEth));
            savedLevel = parseInt(status[1].toString()); if(savedLevel === 0) savedLevel = 1;
            savedLevelInfo.innerText = "Loaded: Level " + savedLevel;
            isGuest = false;
            connectBtn.classList.add('hidden'); playFunBtn.classList.add('hidden'); startBtn.classList.remove('hidden');
            walletDisplay.innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
            walletActionBtn.innerText = "‚ùå DISCONNECT"; walletActionBtn.className = "action-btn danger-btn";
        } catch(e) { console.error(e); connectBtn.innerText = "Retry"; }
        isConnecting = false;
    }
    
    function playForFun() { isGuest = true; savedLevel = 1; currentLevel = 1; walletDisplay.innerText = "Guest Mode"; savedLevelInfo.innerText = "Guest Mode (No Save)"; drawSchool(0); startGame(); }
    window.onload = async function() { drawSchool(0); loadQuests(); if (typeof window.ethereum !== 'undefined') { const provider = new ethers.providers.Web3Provider(window.ethereum); const accounts = await provider.listAccounts(); if (accounts.length > 0) connectWallet(); } };

    // --- MAIN GAME LOOP ---
    function startGame(e) {
        if(e && e.stopPropagation) e.stopPropagation();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        clearInterval(gameLoopId); clearTimeout(spawnerId);
        
        isGameRunning = true; bricks = 0; starsCollected = 0; comboCount = 0;
        if(isNaN(savedLevel)) savedLevel = 1;
        currentLevel = isGuest ? 1 : (savedLevel > 1 ? savedLevel : 1);
        gameSpeed = 6 + ((currentLevel - 1) * 0.5);
        
        updateLevelVisuals(); deactivateShield(); deactivateStar();
        if(hasFire) { shootBtn.style.display = 'flex'; } else { shootBtn.style.display = 'none'; }
        
        obstacles.forEach(ob => ob.element.remove()); obstacles = []; enemies.forEach(en => en.element.remove()); enemies = []; pits.forEach(p => p.element.remove()); pits = []; collectibles.forEach(c => c.element.remove()); collectibles = []; mysteryBoxes.forEach(b => b.element.remove()); mysteryBoxes = []; bullets.forEach(b => b.element.remove()); bullets = []; cages.forEach(c => c.element.remove()); cages = []; 
        
        // --- FORCE CLEANUP BOSS ---
        if(boss) { boss.element.remove(); boss = null; }
        document.querySelectorAll('.boss').forEach(e => e.remove());
        bossMode = false; bossEncountered = false; bossWarning.style.display = 'none';

        startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden');
        playerBottom = 80; player.style.bottom = '80px'; player.classList.remove('jump-anim', 'fall-anim'); player.style.opacity = 1;
        updateUI();
        
        // Move Loop to Priority
        gameLoopId = setInterval(gameLoop, 20);
        spawnManager();
    }

    function backToMenu() {
        isGameRunning = false; clearInterval(gameLoopId); clearTimeout(spawnerId);
        gameOverScreen.classList.add('hidden'); startScreen.classList.remove('hidden');
        document.querySelectorAll('.obstacle, .enemy, .mystery-box, .collectible, .pit, .boss, .cage').forEach(e => e.remove());
        boss = null;
        
        // Reset UI Buttons Logic
        if(isGuest) {
            connectBtn.classList.remove('hidden'); playFunBtn.classList.remove('hidden'); startBtn.classList.add('hidden');
        } else {
            connectBtn.classList.add('hidden'); playFunBtn.classList.remove('hidden'); startBtn.classList.remove('hidden');
        }
    }

    function jump() { if (isGameRunning) { if (playerBottom <= 85) { jumpSpeed = 17; jumpCount = 1; player.classList.add('jump-anim'); playSound('jump'); spawnDust(50, 80); } else if (jumpCount < 2) { jumpSpeed = 14; jumpCount = 2; spawnDust(50, playerBottom); playSound('jump'); } } }
    function shootFireball(e) { if (e) e.stopPropagation(); if (!isGameRunning || !hasFire) return; playSound('shoot'); const bullet = document.createElement('div'); bullet.className = 'fireball'; bullet.style.left = '80px'; bullet.style.bottom = (playerBottom + 25) + 'px'; gameContainer.appendChild(bullet); bullets.push({ element: bullet, pos: 80, bottom: playerBottom + 25 }); }

    function activateShield() { hasShield=true; player.classList.add('shielded'); shieldText.classList.add('shield-active'); playSound('powerup'); }
    function deactivateShield() { hasShield=false; player.classList.remove('shielded'); shieldText.classList.remove('shield-active'); }
    function activateFire() { hasFire=true; player.classList.add('fiery'); fireText.classList.add('fire-active'); shootBtn.style.display = 'flex'; playSound('powerup'); }
    function deactivateFire() { hasFire=false; player.classList.remove('fiery'); fireText.classList.remove('fire-active'); shootBtn.style.display = 'none'; }
    function activateStar() { if(hasStar) clearTimeout(starTimer); hasStar=true; player.classList.add('invincible'); starText.classList.add('star-active'); playSound('powerup'); gameSpeed+=3; starTimer=setTimeout(deactivateStar, 5000); }
    function deactivateStar() { hasStar=false; player.classList.remove('invincible'); starText.classList.remove('star-active'); gameSpeed-=3; }
    function collectStar() { starsCollected++; if (starsCollected >= 3) activateFrenzy(); else activateStarPower(); }
    function activateFrenzy() { isFrenzy = true; starsCollected = 0; gameContainer.classList.add('frenzy-mode'); starText.innerText = "üî• FRENZY!"; starText.classList.add('star-active'); gameSpeed += 5; hasStar = true; player.classList.add('invincible'); playSound('powerup'); setTimeout(deactivateFrenzy, 10000); }
    function deactivateFrenzy() { isFrenzy = false; gameContainer.classList.remove('frenzy-mode'); deactivateStar(); }
    function activateStarPower() { if(hasStar && !isFrenzy) clearTimeout(starTimer); hasStar=true; player.classList.add('invincible'); starText.innerText = "‚≠ê STAR"; starText.classList.add('star-active'); playSound('powerup'); gameSpeed+=2; starTimer=setTimeout(deactivateStar, 5000); }

    function spawnManager() {
        if (!isGameRunning || bossMode) return;
        const rand = Math.random();
        
        if(bricks >= 50 && !bossMode && !bossEncountered) { startBossFight(); return; }
        
        if(bricks > 30 && !hasFire && rand < 0.4) { createMysteryBox(true); }
        else if(rand < 0.05) spawnEnemyGroup();
        else if (rand < 0.15) createMysteryBox(false);
        else if (rand < 0.25) createPit();
        else if (rand < 0.30 && !hasStar) createCage();
        else if (rand < 0.60) createEnemy(450);
        else if (rand < 0.90) createObstacle();
        else createCollectible();
        
        let rate = isFrenzy ? 600 : 1300;
        spawnerId = setTimeout(spawnManager, rate);
    }

    function spawnEnemyGroup() { createEnemy(450); setTimeout(() => { if(isGameRunning) createEnemy(450); }, 500); setTimeout(() => { if(isGameRunning) createEnemy(450); }, 1000); }
    function createMysteryBox(forceFire) { const b=document.createElement('div'); b.className='mystery-box'; b.style.backgroundImage=`url(${boxTexture})`; b.style.left='450px'; b.style.bottom='160px'; gameContainer.appendChild(b); mysteryBoxes.push({element:b, pos:450, bottom:160, hit:false, force:forceFire}); }
    function createEnemy(startPos) { const e=document.createElement('div'); e.className='enemy'; e.style.backgroundImage=`url(${enemyTexture})`; e.style.left=startPos+'px'; e.style.bottom='80px'; gameContainer.appendChild(e); enemies.push({element:e, pos:startPos, bottom:80}); }
    function createPit() { const p=document.createElement('div'); p.className='pit'; p.style.left='450px'; gameContainer.appendChild(p); pits.push({element:p, pos:450}); }
    function createObstacle() { const o=document.createElement('div'); o.className='obstacle'; const r=(typeof obstacleImages!=='undefined'&&obstacleImages.length>0)?obstacleImages[Math.floor(Math.random()*obstacleImages.length)]:''; o.style.backgroundImage=`url('${r}')`; o.style.left='450px'; o.style.bottom=(Math.random()>0.85?'160px':'85px'); gameContainer.appendChild(o); obstacles.push({element:o, pos:450, passed:false}); }
    function createCollectible() { const c=document.createElement('div'); c.className='collectible'; c.style.backgroundImage=`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23d63031'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E")`; c.style.left='450px'; c.style.bottom=(Math.random()>0.5?'120px':'180px'); gameContainer.appendChild(c); collectibles.push({element:c, pos:450}); }
    function createCage() { const c=document.createElement('div'); c.className='cage'; c.style.backgroundImage=`url(${cageTexture})`; c.style.left='450px'; c.style.bottom='85px'; gameContainer.appendChild(c); cages.push({element:c, pos:450, bottom:85}); }

    // --- BOSS LOGIC (WALL OF DOOM) ---
    function startBossFight() { 
        bossMode = true; bossEncountered = true;
        clearTimeout(spawnerId); 
        obstacles.forEach(ob => ob.element.remove()); obstacles = [];
        enemies.forEach(en => en.element.remove()); enemies = [];
        pits.forEach(p => p.element.remove()); pits = [];
        
        bossWarning.style.display = 'block'; 
        setTimeout(() => { bossWarning.style.display = 'none'; createBoss(); }, 2000); 
    }
    
    function createBoss() { 
        const b = document.createElement('div'); b.className = 'boss'; 
        const healthBar = document.createElement('div'); healthBar.className = 'boss-health-bar';
        const healthFill = document.createElement('div'); healthFill.className = 'boss-health-fill';
        healthBar.appendChild(healthFill); b.appendChild(healthBar);
        
        if(currentLevel < 5) { b.style.backgroundImage = `url(${bossTextures.red})`; b.bossType = 'red'; b.hp = 10; }
        else if(currentLevel < 10) { b.style.backgroundImage = `url(${bossTextures.flying})`; b.bossType = 'flying'; b.hp = 15; b.style.bottom = '150px'; }
        else { b.style.backgroundImage = `url(${bossTextures.stone})`; b.bossType = 'stone'; b.hp = 20; }
        b.maxHp = b.hp;
        
        // Spawn Visible
        b.style.left = '350px'; if(b.bossType !== 'flying') b.style.bottom = '80px';
        gameContainer.appendChild(b); 
        
        // Wall of Doom: Just move left
        boss = { element: b, healthFill: healthFill, hp: b.hp, maxHp: b.maxHp, type: b.bossType, x: 350 }; 
    }

    function gameLoop() {
        if(!isGameRunning) return;

        // 1. ALWAYS MOVE BOSS IF EXISTS (Priority)
        if(bossMode && boss) {
            boss.x -= 1.5; // Consistent Doom Speed
            boss.element.style.left = boss.x + 'px';
            if(boss.x < 60) { playSound('die'); gameOver(); }
        }

        if (playerBottom > 80 || jumpSpeed > 0) { playerBottom += jumpSpeed; jumpSpeed -= 0.9; player.style.bottom = playerBottom + 'px'; } 
        else { let inPit = false; pits.forEach(p => { if (p.pos < 70 && p.pos > 20) inPit = true; }); if (!inPit) { if(jumpSpeed<0) spawnDust(50, 80); jumpSpeed = 0; playerBottom = 80; jumpCount = 0; player.classList.remove('jump-anim'); } else { playerBottom -= 8; if (isGameRunning) { player.classList.add('fall-anim'); playSound('die'); setTimeout(gameOver, 600); isGameRunning = false; } } player.style.bottom = playerBottom + 'px'; }

        bullets.forEach((bull, i) => {
            bull.pos += 10; bull.element.style.left = bull.pos + 'px'; let hit = false;
            if(bossMode && boss && !hit) {
                if(bull.pos > boss.x && bull.pos < boss.x + 120) {
                     hit = true; boss.hp--; 
                     boss.element.classList.add('boss-hit'); setTimeout(()=>boss.element.classList.remove('boss-hit'), 100);
                     boss.healthFill.style.width = (boss.hp / boss.maxHp * 100) + '%';
                     
                     // Push back
                     boss.x += 30; if(boss.x > 350) boss.x = 350; 
                     
                     if(boss.hp <= 0) { 
                        playSound('boss_die'); boss.element.remove(); boss = null; bossMode = false; bossEncountered = false; 
                        spawnFloatingText(bull.pos, 100, "BOSS DEFEATED!", 'normal'); 
                        bricks = 0; currentLevel++; savedLevel = currentLevel; 
                        levelUp(); spawnManager(); deactivateFire(); updateQuest('boss', 1); 
                     } else { playSound('break'); }
                }
            }
            enemies.forEach((en, j) => { if(!hit && bull.pos > en.pos && bull.pos < en.pos + 40) { en.element.remove(); enemies.splice(j, 1); hit = true; spawnFloatingText(bull.pos, 80, "BOOM!", 'normal'); playSound('break'); } }); 
            if(!hit) { obstacles.forEach((ob, k) => { if(!hit && bull.pos > ob.pos && bull.pos < ob.pos + 40) { ob.element.remove(); obstacles.splice(k, 1); hit = true; spawnFloatingText(bull.pos, 80, "CRASH!", 'normal'); playSound('break'); } }); } 
            if (hit || bull.pos > 400) { bull.element.remove(); bullets.splice(i, 1); } 
        });

        cages.forEach((c, i) => { c.pos -= gameSpeed; c.element.style.left = c.pos + 'px'; if (c.pos < -50) { c.element.remove(); cages.splice(i, 1); return; } if (isGameRunning && c.pos > 10 && c.pos < 70 && playerBottom >= 85 && jumpSpeed <= 0) { c.element.remove(); cages.splice(i, 1); playSound('rescue'); spawnFloatingText(c.pos, 130, "SAVED!", 'normal'); bricks += 20; updateUI(); jumpSpeed = 10; } });
        mysteryBoxes.forEach((b, i) => { b.pos -= gameSpeed; b.element.style.left = b.pos + 'px'; if (b.pos < -50) { b.element.remove(); mysteryBoxes.splice(i, 1); return; } if (!b.hit && isGameRunning && b.pos > 10 && b.pos < 70 && playerBottom + 50 >= b.bottom && playerBottom < b.bottom && jumpSpeed > 0) { b.hit=true; b.element.classList.add('box-hit','box-empty'); jumpSpeed=-5; playSound('bump'); spawnFloatingText(b.pos, b.bottom, "GIFT!", 'normal'); if(b.force || !hasFire) activateFire(); else { const r=Math.random(); if(r<0.3) activateShield(); else if(r<0.6) activateFire(); else collectStar(); } } });
        enemies.forEach((en, i) => { en.pos -= gameSpeed; en.element.style.left = en.pos + 'px'; if (en.pos < -50) { en.element.remove(); enemies.splice(i, 1); return; } if (isGameRunning && en.pos > 10 && en.pos < 60) { let enH = 120; if (playerBottom >= 100 && jumpSpeed <= 0) { playSound('stomp'); jumpSpeed = 12; en.element.remove(); enemies.splice(i, 1); let m=addCombo(); bricks += 5*m; updateUI(); spawnFloatingText(en.pos, enH, `+${5*m}`, 'normal'); } else if (playerBottom < enH - 10) { if (hasStar || hasShield) { playSound('break'); if(hasShield) deactivateShield(); en.element.remove(); enemies.splice(i, 1); shakeScreen(); } else if (hasFire) { playSound('break'); en.element.remove(); enemies.splice(i, 1); deactivateFire(); } else { playSound('die'); gameOver(); } } } });
        obstacles.forEach((ob, i) => { ob.pos -= gameSpeed; ob.element.style.left = ob.pos + 'px'; if (ob.pos < -50) { ob.element.remove(); obstacles.splice(i, 1); } if (ob.pos < 50 && !ob.passed) { bricks++; updateUI(); ob.passed = true; updateQuest('brick', 1); } if (isGameRunning && ob.pos > 10 && ob.pos < 60) { let obH = parseInt(ob.element.style.bottom); if ((obH < 100 && playerBottom < 125) || (obH > 100 && playerBottom > 100 && playerBottom < 200)) { if (hasStar || hasShield) { playSound('break'); if(hasShield) deactivateShield(); ob.element.remove(); obstacles.splice(i, 1); if(hasStar) { bricks+=2; updateUI(); } shakeScreen(); } else if (hasFire) { playSound('break'); ob.element.remove(); obstacles.splice(i, 1); deactivateFire(); } else { playSound('die'); gameOver(); } } } });
        pits.forEach((p, i) => { p.pos -= gameSpeed; p.element.style.left = p.pos + 'px'; if (p.pos < -100) { p.element.remove(); pits.splice(i, 1); } });
        collectibles.forEach((c, i) => { if (hasMagnet && isGameRunning && c.pos < 400 && c.pos > -50) { let dx = 50 - c.pos; let dy = playerBottom - parseInt(c.element.style.bottom); c.pos += dx * 0.15; c.element.style.bottom = (parseInt(c.element.style.bottom) + dy * 0.15) + 'px'; } else { c.pos -= gameSpeed; } c.element.style.left = c.pos + 'px'; if (c.pos < -50) { c.element.remove(); collectibles.splice(i, 1); } let cH = parseInt(c.element.style.bottom); if (isGameRunning && c.pos > 10 && c.pos < 70 && playerBottom + 40 >= cH && playerBottom <= cH + 40) { playSound('collect'); c.element.remove(); collectibles.splice(i, 1); let m=addCombo(); bricks += 5*m; updateUI(); spawnFloatingText(c.pos, cH, `+${5*m}`, 'normal'); } });
    }

    function levelUp() { currentLevel++; gameSpeed += 0.5; playSound('levelup'); levelUpMsg.classList.remove('show-levelup'); void levelUpMsg.offsetWidth; levelUpMsg.classList.add('show-levelup'); levelUpMsg.innerText = "LEVEL " + currentLevel; updateLevelVisuals(); updateUI(); }
    function updateLevelVisuals() { const filters = ['none', 'sepia(0.5) hue-rotate(-30deg)', 'brightness(0.6) hue-rotate(240deg)', 'brightness(1.2) hue-rotate(180deg) contrast(0.8)']; gameContainer.style.filter = filters[(currentLevel - 1) % 4]; }
    function updateUI() { scoreBoard.innerHTML = `üíé ${bricks}`; levelDisplay.innerHTML = `LVL ${currentLevel}`; }
    function gameOver() { isGameRunning = false; clearTimeout(spawnerId); clearInterval(gameLoopId); deactivateFrenzy(); document.getElementById('finalScore').innerText = bricks; document.getElementById('multiplierSlider').value = 1; window.updateDonationCalc(); gameOverScreen.classList.remove('hidden'); if(isGuest) { payBtn.innerHTML = "CONNECT TO SAVE"; payBtn.style.background = "#8e44ad"; } else { payBtn.innerHTML = "DONATE & RANK"; payBtn.style.background = "#00b894"; } }
    async function processDonation() { if(isGuest) { await connectWallet(); return; } if (typeof window.ethereum === 'undefined') return alert("Please install MetaMask"); try { payBtn.innerText = "‚è≥ Network..."; payBtn.disabled = true; await switchToSoneium(); payBtn.innerText = "‚è≥ Signing..."; const provider = new ethers.providers.Web3Provider(window.ethereum); await provider.send("eth_requestAccounts", []); const signer = provider.getSigner(); const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer); const m = parseInt(document.getElementById('multiplierSlider').value); const score = bricks > 0 ? bricks : 1; const costRaw = (score * m * BASE_PRICE).toFixed(5); const costWei = ethers.utils.parseEther(costRaw.toString()); const tx = await contract.submitScoreAndDonate(currentLevel, { value: costWei }); payBtn.innerText = "‚è≥ Confirming..."; await tx.wait(); alert(`‚úÖ Ticket Confirmed!\nüèÜ Lottery Pool Increased.\nüíæ Level ${currentLevel} Saved.`); location.reload(); } catch(e) { console.error(e); alert("Transaction Failed: " + e.message); payBtn.innerText = "DONATE & RANK"; payBtn.disabled = false; } }
    window.updateDonationCalc = function() { const m = document.getElementById('multiplierSlider').value; document.getElementById('multiplierValue').innerText = m + "x"; const score = bricks > 0 ? bricks : 1; document.getElementById('ethCost').innerText = (score * m * BASE_PRICE).toFixed(5) + " ETH"; }
    gameContainer.addEventListener('mousedown', jump); gameContainer.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); }); document.addEventListener('keydown', (e) => { if(e.code === 'Space') jump(); });
</script>
</body>
</html>