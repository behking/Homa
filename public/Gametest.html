<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Homa Runner - Full Features</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        body { margin: 0; padding: 0; background-color: #202020; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'VT323', 'Arial', sans-serif; overflow: hidden; color: white; user-select: none; }
        
        #gameContainer {
            position: relative; width: 100%; max-width: 400px; height: 600px;
            background-image: url('Background.png');
            background-size: cover; background-position: center;
            overflow: hidden; border: 4px solid #333; border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7); image-rendering: pixelated;
        }
        
        /* HUD */
        .hud { position: absolute; z-index: 20; text-shadow: 2px 2px 0 #000; pointer-events: none; }
        #projectStatus { top: 0; left: 0; width: 100%; background: rgba(108, 92, 231, 0.95); padding: 5px 0; text-align: center; font-size: 14px; border-bottom: 3px solid #fab1a0; color: #fff; }
        #lotteryPot { top: 40px; right: 10px; color: #ffd700; font-size: 20px; }
        #scoreBoard { top: 40px; left: 20px; font-size: 24px; color: #fff; }
        #levelDisplay { top: 70px; left: 20px; font-size: 18px; color: #fab1a0; }
        
        #powerupStatus { top: 100px; left: 20px; display: flex; flex-direction: column; gap: 5px; }
        .status-item { font-size: 18px; opacity: 0; transition: 0.3s; font-weight: bold; }
        
        /* BOSS WARNING */
        #bossWarning { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; color: #e74c3c; text-shadow: 4px 4px 0 #000; z-index: 50; display: none; animation: blink 0.2s infinite; text-align: center; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; border: 2px solid red; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } }

        /* SCREENS */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45, 52, 54, 0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 30; backdrop-filter: blur(5px); }
        .panel { background: #1a1b26; border: 2px solid #7aa2f7; padding: 20px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 0 40px rgba(122, 162, 247, 0.4); }
        .hidden { display: none !important; }
        
        h1 { font-size: 45px; margin: 0 0 10px 0; color: #7aa2f7; text-shadow: 0 0 15px #7aa2f7; letter-spacing: 2px; }

        /* BUTTONS */
        button.action-btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px; font-family: 'VT323'; font-size: 20px; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        button.action-btn:active { transform: scale(0.96); }
        .btn-primary { background: #7aa2f7; color: #fff; }
        .btn-green { background: #9ece6a; color: #1a1b26; }
        .btn-danger { background: #f7768e; color: #fff; border: 1px solid #fff; }
        
        /* GAME OBJECTS */
        #player { 
            position: absolute; width: 50px; height: 50px; bottom: 80px; left: 50px; z-index: 5; 
            background-image: url('Teddy_Bear.png'); background-size: contain; background-repeat: no-repeat;
            transition: filter 0.3s;
        }
        .jump { animation: jump-anim 0.5s ease-out; }
        @keyframes jump-anim { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-30px) rotate(15deg); } 100% { transform: translateY(0) rotate(0deg); } }
        
        .obstacle, .enemy, .pit, .collectible, .mystery-box, .fireball, .boss { position: absolute; background-size: contain; background-repeat: no-repeat; z-index: 4; }
        
        .obstacle { width: 40px; height: 60px; } /* Obstacle_X.png set in JS */
        .enemy { width: 40px; height: 40px; background-image: url('Obstacle_1.png'); }
        .mystery-box { width: 40px; height: 40px; background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect width='40' height='40' fill='%23f1c40f' stroke='%23fff' stroke-width='3'/><text x='20' y='32' font-size='30' text-anchor='middle' fill='white' font-family='monospace' font-weight='bold'>?</text></svg>"); animation: pulseBox 1s infinite; }
        
        .fireball { width: 30px; height: 30px; background: radial-gradient(#ff9f43, #e74c3c); border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 10px #e74c3c; z-index: 6; }
        
        .pit { width: 80px; height: 90px; bottom: 0; z-index: 2; background: linear-gradient(to top, #cf1020, #ff4500); border-left: 5px solid #333; border-right: 5px solid #333; }
        
        .boss { width: 140px; height: 140px; background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M10 30 Q50 0 90 30 L90 90 L10 90 Z' fill='%23d63031'/><circle cx='30' cy='50' r='10' fill='white'/><circle cx='70' cy='50' r='10' fill='white'/><path d='M30 80 Q50 60 70 80' stroke='black' stroke-width='5' fill='none'/></svg>"); z-index: 6; }
        .boss-hit { filter: brightness(2) sepia(1); }

        #shootBtn { position: absolute; bottom: 20px; right: 20px; width: 80px; height: 80px; background: radial-gradient(circle, #e74c3c, #c0392b); border: 4px solid #fff; border-radius: 50%; color: white; font-size: 40px; display: flex; justify-content: center; align-items: center; z-index: 50; display: none; cursor: pointer; box-shadow: 0 0 20px #c0392b; }
        
        #ground { position: absolute; bottom: 0; width: 100%; height: 100px; z-index: 3; background-image: url('Foreground.png'); background-repeat: repeat-x; background-size: auto 100%; }
        
        .float-text { position: absolute; font-size: 24px; color: #ffd700; z-index: 20; animation: floatUp 0.8s ease-out forwards; text-shadow: 2px 2px 0 #000; font-weight: bold; }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
        @keyframes pulseBox { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* USER STATUS BOX (SNAKE STYLE) */
        .user-status-box { 
            background: rgba(122, 162, 247, 0.15); border: 1px solid #7aa2f7; 
            padding: 8px; border-radius: 10px; margin: 10px 0; 
            display: flex; justify-content: space-between; align-items: center; 
            font-family: 'VT323';
        }
        .user-stat-item { text-align: center; flex: 1; }
        .user-stat-val { font-weight: bold; color: #fff; font-size: 20px; line-height: 1; }
        .user-stat-lbl { font-size: 12px; opacity: 0.7; color: #a9b1d6; }
        
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #6c5ce7; }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="projectStatus" class="hud">üèóÔ∏è School Project | Funds: <span id="funds">...</span></div>
    <div id="lotteryPot" class="hud">üèÜ POT: 0.00</div>
    <div id="scoreBoard" class="hud">üíé 0</div>
    <div id="levelDisplay" class="hud">LVL 1</div>
    <div id="bossWarning">‚ö†Ô∏è BOSS! ‚ö†Ô∏è</div>
    
    <div id="powerupStatus" class="hud">
        <div id="shieldText" class="status-item" style="color:#00cec9">üõ°Ô∏è SHIELD</div>
        <div id="fireText" class="status-item" style="color:#ff7675">üî• FIRE</div>
    </div>
    
    <div id="shootBtn">üî•</div>

    <div id="startScreen" class="screen">
        <h1>HOMA RUNNER</h1>
        <button id="connectBtn" class="action-btn btn-primary" onclick="connectWallet()">üîå CONNECT WALLET</button>
        <button id="playBtn" class="action-btn btn-outline" style="background:transparent; border:2px solid #fff;" onclick="startGuest()">üéÆ PLAY GUEST</button>
        <button id="startBtn" class="action-btn btn-green hidden" onclick="startGame()">‚ñ∂ START GAME</button>
        <p style="margin-top:10px; color:#fab1a0;" id="walletStatus">Guest Mode</p>
    </div>

    <div id="reviveScreen" class="screen hidden">
        <div class="panel">
            <h2 style="color:#e74c3c">CONTINUE?</h2>
            <div id="countdown" style="font-size:60px; color:#fff;">5</div>
            <p>Don't lose your score!</p>
            <button class="action-btn btn-green" onclick="revive()">‚ù§Ô∏è REVIVE (FREE)</button>
            <button class="action-btn btn-danger" onclick="revive(true)">üî• REVIVE + FIRE</button>
            <button onclick="giveUp()" style="background:none; border:none; color:#a9b1d6; margin-top:10px; cursor:pointer;">NO THANKS</button>
        </div>
    </div>

    <div id="gameOverScreen" class="screen hidden">
        <div class="panel">
            <h2 style="color:#f7768e">GAME OVER</h2>
            <p style="font-size:24px; margin-bottom:15px;">Score: <span id="finalScore" style="color:#ffd700">0</span></p>
            
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:15px; margin:10px 0; text-align:left;">
                
                <div id="userStatusBox" class="user-status-box hidden">
                    <div class="user-stat-item">
                        <div class="user-stat-val" id="userTickets">0</div>
                        <div class="user-stat-lbl">Tickets</div>
                    </div>
                    <div class="user-stat-item" style="border-left:1px solid #555; border-right:1px solid #555;">
                        <div class="user-stat-val" id="userCents">0¬¢</div>
                        <div class="user-stat-lbl">Pot</div>
                    </div>
                    <div class="user-stat-item">
                        <div class="user-stat-val" id="userNextTicket" style="color:#ffd700">100¬¢</div>
                        <div class="user-stat-lbl" style="color:#ffd700">Next Ticket</div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; font-size:14px; margin-top:10px;">
                    <span>Donate:</span>
                    <span id="usdAmount" style="color:#ffd700">$1.00</span>
                </div>
                <input type="range" id="donationSlider" min="0.1" max="10" step="0.1" value="1" oninput="updateCost(this.value)">
                <div style="font-size:10px; color:#9ece6a; text-align:right;" id="ethCost">... ETH</div>
            </div>

            <button id="donateBtn" class="action-btn btn-green" onclick="donate()">üíæ SAVE & DONATE</button>
            <div style="display:flex; gap:10px;">
                <button class="action-btn btn-primary" onclick="startGame()">üîÑ REPLAY</button>
                <button class="action-btn btn-danger" onclick="location.reload()">EXIT</button>
            </div>
        </div>
    </div>

    <div id="player"></div>
    <div id="ground"></div>
</div>

<script>
    // --- ASSETS & CONFIG ---
    const obstacleImages = ['Obstacle_1.png', 'Obstacle_2.png', 'Obstacle_3.png'];
    const CONTRACT_ADDRESS = "0xB53223EE5B4C269A87617C8Ac798FcB7e2FDB1FE"; // V6 Protocol
    const RPC_URL = "https://rpc.minato.soneium.org/";
    const CHAIN_ID_HEX = '0x79a'; 
    const ABI = [
        "function donate(uint256, bool, string, uint256) public payable",
        "function getUserAccumulation(address) public view returns (uint256 cents, uint256 tickets)"
    ];

    // --- STATE ---
    let isRunning = false;
    let gameLoopId, spawnerId, reviveTimerId;
    let score=0, level=1, gameSpeed=6;
    let playerY=80, jumpSpeed=0;
    let entities=[], bullets=[], boss=null;
    
    // Powerups
    let hasFire=false, hasShield=false;
    let bossMode=false;
    
    // Wallet
    let isGuest=true, signer=null, userAddress=null, contract=null;
    let ethPrice=3000, userCurrentCents=0;

    window.onload = () => {
        fetchPrice();
        if(window.ethereum) {
            const p = new ethers.providers.Web3Provider(window.ethereum);
            p.listAccounts().then(acc => { if(acc.length>0) connectWallet(true); });
        }
    };

    // --- GAME ENGINE ---
    function resetEngine() {
        isRunning = false;
        clearInterval(gameLoopId);
        clearTimeout(spawnerId);
        clearInterval(reviveTimerId);
        
        entities.forEach(e => e.el.remove()); entities = [];
        bullets.forEach(b => b.el.remove()); bullets = [];
        if(boss) { boss.el.remove(); boss = null; }
        document.querySelectorAll('.boss').forEach(e => e.remove());
        
        playerY = 80; jumpSpeed = 0;
        const p = document.getElementById('player');
        p.style.bottom = '80px';
        p.classList.remove('jump');
        p.style.filter = 'none'; 
        
        document.getElementById('bossWarning').style.display = 'none';
        bossMode = false;
    }

    function startGame() {
        resetEngine();
        isRunning = true;
        score = 0; level = 1; gameSpeed = 6;
        hasFire = false; hasShield = false;
        updateUI();
        
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById('reviveScreen').classList.add('hidden');

        gameLoopId = setInterval(loop, 20);
        spawnManager();
    }

    function loop() {
        if(!isRunning) return;

        // 1. Physics
        if(playerY > 80 || jumpSpeed > 0) {
            playerY += jumpSpeed; jumpSpeed -= 0.9;
        } else {
            let inPit = entities.some(e => e.type==='pit' && e.x < 60 && e.x > 20);
            if(inPit) {
                playerY -= 10;
                if(playerY < -50) triggerDeath();
            } else {
                playerY = 80; jumpSpeed = 0;
                document.getElementById('player').classList.remove('jump');
            }
        }
        document.getElementById('player').style.bottom = playerY + 'px';

        // 2. Entities
        for(let i=entities.length-1; i>=0; i--) {
            let e = entities[i];
            e.x -= gameSpeed;
            e.el.style.left = e.x + 'px';
            
            if(e.x < -50) { e.el.remove(); entities.splice(i,1); continue; }
            
            // Collectible Magnet (if Shield/Fire active)
            if(e.type === 'collectible' && (hasShield || hasFire) && e.x < 300) {
                e.y += (playerY + 25 - e.y) * 0.1;
                e.x -= 2; // Move faster towards player
                e.el.style.bottom = e.y + 'px';
            }

            // Collision
            if(e.x > 10 && e.x < 60 && playerY < e.y + 40 && playerY + 40 > e.y) {
                if(e.type === 'box') {
                    e.el.remove(); entities.splice(i,1);
                    triggerPowerup();
                    spawnText(e.x, e.y, "POWER UP!");
                } else if (e.type === 'collectible') {
                    score += 5; e.el.remove(); entities.splice(i,1); updateUI();
                } else if(e.type !== 'pit') {
                    // Enemy/Obstacle
                    if(hasShield) {
                        hasShield=false; e.el.remove(); entities.splice(i,1); 
                        spawnText(e.x, e.y, "SHIELD BREAK!");
                        updateUI();
                    } else if(hasFire && e.type === 'enemy') {
                         // Fire protects against small enemies? Let's say yes for fun, or just shoot.
                         // Standard rule: Fire is weapon, Shield is armor.
                         triggerDeath();
                    } else {
                        triggerDeath();
                    }
                }
            }
        }

        // 3. Bullets
        for(let i=bullets.length-1; i>=0; i--) {
            let b = bullets[i];
            b.x += 12; b.el.style.left = b.x + 'px';
            
            // Hit Boss
            if(boss && b.x > boss.x && b.x < boss.x + 100) {
                boss.hp--;
                boss.el.classList.add('boss-hit');
                setTimeout(()=>boss.el.classList.remove('boss-hit'), 100);
                
                boss.x += 20; if(boss.x > 350) boss.x = 350; // Pushback
                b.el.remove(); bullets.splice(i,1);
                
                if(boss.hp <= 0) {
                    boss.el.remove(); boss = null; bossMode = false;
                    score += 100; level++; 
                    updateUI(); spawnManager(); spawnText(200, 300, "BOSS DEFEATED!");
                }
                continue;
            }
            if(b.x > 400) { b.el.remove(); bullets.splice(i,1); }
        }

        // 4. Boss Logic
        if(boss) {
            boss.x -= 0.5 + (level * 0.1); 
            boss.el.style.left = boss.x + 'px';
            if(boss.x < 50) triggerDeath(); 
        }
    }

    function spawnManager() {
        if(!isRunning || bossMode) return;
        if(score > (level * 50) && !bossMode) { startBoss(); return; }
        
        const r = Math.random();
        let type = 'collectible';
        
        // Logic similar to first code
        if(score > 20 && !hasFire && !hasShield && r < 0.15) type='box';
        else if(r < 0.1) type='enemy';
        else if(r < 0.25) type='pit';
        else if(r < 0.7) type='obstacle';
        else type='collectible';

        const el = document.createElement('div');
        el.className = type;
        
        // Use Images if obstacle/enemy
        if(type === 'obstacle') {
             const rndImg = obstacleImages[Math.floor(Math.random()*obstacleImages.length)];
             el.style.backgroundImage = `url('${rndImg}')`;
        }
        if(type === 'collectible') {
             el.style.backgroundImage = "url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'><circle cx='10' cy='10' r='8' fill='%23f1c40f' stroke='%23f39c12' stroke-width='2'/></svg>\")";
        }
        
        let obj = { el, type, x: 450, y: 80 };
        if(type==='pit') { el.className='pit'; obj.y=0; }
        if(type==='collectible') { el.className='collectible'; obj.y=150 + (Math.random()*50); }
        if(type==='box') { obj.y = 150; }
        
        el.style.left = obj.x + 'px';
        el.style.bottom = obj.y + 'px';
        document.getElementById('gameContainer').appendChild(el);
        entities.push(obj);

        spawnerId = setTimeout(spawnManager, 1500 - (level * 80));
    }

    function triggerPowerup() {
        if(Math.random() > 0.5) {
            hasFire = true; spawnText(200, 300, "FIREBALL!");
        } else {
            hasShield = true; spawnText(200, 300, "SHIELD UP!");
        }
        updateUI();
    }

    function startBoss() {
        bossMode = true;
        clearTimeout(spawnerId);
        entities.forEach(e => e.el.remove()); entities = [];
        
        document.getElementById('bossWarning').style.display = 'block';
        setTimeout(() => {
            document.getElementById('bossWarning').style.display = 'none';
            const el = document.createElement('div');
            el.className = 'boss';
            el.style.left = '350px'; el.style.bottom = '80px';
            document.getElementById('gameContainer').appendChild(el);
            boss = { el, x: 350, hp: 5 + (level * 2) };
            // Ensure player has fire to fight boss
            if(!hasFire) { hasFire = true; spawnText(50, 200, "WEAPON EQUIPPED!"); }
            updateUI();
        }, 2000);
    }

    // --- CONTROLS ---
    function jump() { if(isRunning && playerY <= 85) { jumpSpeed = 17; document.getElementById('player').classList.add('jump'); } }
    function shoot(e) {
        if(e) e.stopPropagation();
        if(isRunning && hasFire) {
            const el = document.createElement('div'); el.className = 'fireball';
            el.style.left = '80px'; el.style.bottom = (playerY+25)+'px';
            document.getElementById('gameContainer').appendChild(el);
            bullets.push({ el, x: 80 });
        }
    }

    function triggerDeath() {
        isRunning = false; clearInterval(gameLoopId); clearTimeout(spawnerId);
        document.getElementById('reviveScreen').classList.remove('hidden');
        let t=5; document.getElementById('countdown').innerText=t;
        reviveTimerId=setInterval(()=>{ t--; document.getElementById('countdown').innerText=t; if(t<=0) giveUp(); }, 1000);
    }

    function revive(plusFire=false) {
        clearInterval(reviveTimerId);
        document.getElementById('reviveScreen').classList.add('hidden');
        isRunning=true; hasShield=true; 
        if(plusFire) hasFire=true;
        
        // Clear immediate danger
        entities.forEach(e=>{if(e.x<250)e.el.remove()});
        entities=entities.filter(e=>e.x>=250);
        
        updateUI();
        gameLoopId=setInterval(loop, 20);
        if(!bossMode) spawnManager();
    }

    function giveUp() {
        clearInterval(reviveTimerId);
        document.getElementById('reviveScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.remove('hidden');
        document.getElementById('finalScore').innerText = score;
        if(signer) loadUserStats();
    }

    function updateUI() {
        document.getElementById('scoreBoard').innerText = `üíé ${score}`;
        document.getElementById('levelDisplay').innerText = `LVL ${level}`;
        document.getElementById('shieldText').style.opacity = hasShield ? 1 : 0.2;
        document.getElementById('fireText').style.opacity = hasFire ? 1 : 0.2;
        document.getElementById('shootBtn').style.display = hasFire ? 'flex' : 'none';
        
        const p = document.getElementById('player');
        if(hasShield) p.style.filter = "drop-shadow(0 0 5px #00cec9)";
        else if(hasFire) p.style.filter = "drop-shadow(0 0 5px #e74c3c)";
        else p.style.filter = "none";
    }
    
    function spawnText(x, y, text) { 
        const el=document.createElement('div'); el.className='float-text'; el.innerText=text; 
        el.style.left=x+'px'; el.style.bottom=y+'px'; 
        document.getElementById('gameContainer').appendChild(el); setTimeout(()=>el.remove(), 800); 
    }

    // --- WALLET INTEGRATION ---
    async function connectWallet(silent=false) {
        if(!window.ethereum) { if(!silent) alert("Install Wallet"); return; }
        try {
            const btn = document.getElementById('connectBtn');
            if(!silent) btn.innerText = "‚è≥...";
            
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            
            try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID_HEX }] }); } catch(e){}
            
            isGuest = false;
            document.getElementById('walletStatus').innerText = userAddress.substring(0,6)+"...";
            
            btn.innerText = "‚ùå DISCONNECT";
            btn.classList.remove('btn-primary'); btn.classList.add('btn-danger');
            btn.onclick = () => location.reload();

            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('playBtn').classList.add('hidden'); 
            
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            loadUserStats();
            
        } catch(e) { console.error(e); if(!silent) document.getElementById('connectBtn').innerText = "CONNECT WALLET"; }
    }
    function startGuest() { isGuest=true; document.getElementById('walletStatus').innerText="Guest"; startGame(); }

    async function loadUserStats() {
        try {
            const data = await contract.getUserAccumulation(userAddress);
            const cents = data.cents.toNumber();
            const tickets = data.tickets.toNumber();
            userCurrentCents = cents; 
            
            document.getElementById('userTickets').innerText = tickets;
            document.getElementById('userCents').innerText = (cents % 100) + "¬¢";
            document.getElementById('userNextTicket').innerText = (100 - (cents % 100)) + "¬¢";
            
            document.getElementById('userStatusBox').classList.remove('hidden');
            updateCost(document.getElementById('donationSlider').value);
        } catch(e){ console.log("Stats error", e); }
    }

    async function fetchPrice() { try{ const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd'); const d=await r.json(); ethPrice=d.ethereum.usd; }catch(e){} updateCost(1); }

    function updateCost(usd) { 
        document.getElementById('usdAmount').innerText="$"+usd; 
        document.getElementById('ethCost').innerText=(usd/ethPrice).toFixed(6)+" ETH";
    }

    async function donate() {
        if(!signer){ await connectWallet(); if(!signer) return; }
        const usd=document.getElementById('donationSlider').value;
        const wei=ethers.utils.parseEther((usd/ethPrice).toFixed(18));
        const cents = Math.floor(usd * 100);
        try {
            const btn=document.getElementById('donateBtn'); btn.innerText="‚è≥ Signing..."; btn.disabled=true;
            // Project Index 0, isDonation=true, Message="HomaRunner", cents
            const tx=await contract.donate(0, true, "HomaRunner", cents, {value:wei});
            await tx.wait(); alert("Saved! üèÉ‚Äç‚ôÇÔ∏è"); location.reload();
        } catch(e){ alert("Error: "+e.message); document.getElementById('donateBtn').innerText="üíæ SAVE"; document.getElementById('donateBtn').disabled=false; }
    }

    // --- INPUTS ---
    const c = document.getElementById('gameContainer');
    c.addEventListener('mousedown', jump);
    c.addEventListener('touchstart', (e)=>{e.preventDefault(); jump()});
    document.addEventListener('keydown', (e)=>{if(e.code==='Space')jump()});
    document.getElementById('shootBtn').onclick = shoot;

</script>
</body>
</html>